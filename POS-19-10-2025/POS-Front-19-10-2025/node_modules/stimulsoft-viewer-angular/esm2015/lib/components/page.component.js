import { __decorate } from "tslib";
import { Component, Input, ViewChild } from '@angular/core';
import { ModelService } from '../services/model.service';
import { ControllerService } from '../services/controller.service';
let PageComponent = class PageComponent {
    constructor(model, controller) {
        this.model = model;
        this.controller = controller;
        this.touchesLength = 0;
        this.lastTouches = [{ x: 0, y: 0, time: 0 }, { x: 0, y: 0, time: 0 }];
        this.touchAllowPageAction = false;
        this.touchAllowScroll = false;
    }
    ngOnInit() {
    }
    ngAfterViewInit() {
        const page = this.element.nativeElement;
        page.innerHTML = this.pageAttributes.content;
        this.pageAttributes.page = page;
        // Correct Watermark
        if (this.pageAttributes.existsWatermark) {
            page.style.position = 'relative';
            for (const childNode of page.childNodes) {
                if (childNode.className === 'stiWatermarkImage') {
                    childNode.style.width = 'auto';
                    childNode.style.height = 'auto';
                    break;
                }
            }
        }
        if (this.model.options.appearance.reportDisplayMode === 'Div' || this.model.options.appearance.reportDisplayMode === 'Span') {
            const childs = page.getElementsByClassName('StiPageContainer');
            if (childs && childs.length > 0) {
                const pageContainer = childs[0];
                pageContainer.style.position = 'relative';
                if (this.model.options.appearance.reportDisplayMode === 'Span') {
                    pageContainer.style.margin = '0 1px'; // fix Chrome bug with SPAN position
                }
                page.style.width = (page.pageWidth - page.margins[1] - page.margins[3]) + 'px';
                page.style.height = (page.pageHeight - page.margins[0] - page.margins[2]) + 'px';
            }
        }
        this.element.nativeElement.pageAttributes = this.pageAttributes;
        /*const pageHeight = this.pageHeight;
        if (pageHeight !== 0) {
          // fixed bug with long time execute
          if (this.model.options.appearance.reportDisplayMode !== 'Table' && this.model.reportParams.viewMode !== 'SinglePage') {
            setTimeout(() => {
              const currentPageHeight = page.offsetHeight - this.margins[0] - this.margins[2];
              if (this.reportPanel.maxHeights[pageHeight] == null || currentPageHeight > this.reportPanel.maxHeights[pageHeight]) {
                this.reportPanel.maxHeights[pageHeight] = currentPageHeight;
              }
            });
          } else {
            const currentPageHeight = page.offsetHeight - this.margins[0] - this.margins[2];
            if (this.reportPanel.maxHeights[pageHeight] === null || currentPageHeight > this.reportPanel.maxHeights[pageHeight]) {
              this.reportPanel.maxHeights[pageHeight] = currentPageHeight;
            }
          }
        }*/
    }
    get margins() {
        const margins = [0, 0, 0, 0];
        if (this.pageAttributes.margins) {
            const marginsPx = this.pageAttributes.margins.split(' ');
            for (let i = 0; i < marginsPx.length; i++) {
                margins[i] = parseInt(marginsPx[i].replace('px', ''), 10);
            }
        }
        return margins;
    }
    get pageWidth() {
        const pageSizes = this.pageAttributes.sizes ? this.pageAttributes.sizes.split(';') : null;
        if (pageSizes) {
            return parseInt(pageSizes[0], 10);
        }
        return 0;
    }
    get pageHeight() {
        const pageSizes = this.pageAttributes.sizes ? this.pageAttributes.sizes.split(';') : null;
        if (pageSizes) {
            return parseInt(pageSizes[1], 10);
        }
        return 0;
    }
    eventTouchStart(e) {
        const reportPanel = this.model.controls.reportPanel.el.nativeElement;
        this.touchAllowPageAction = this.touchesLength === 0 && Math.abs(reportPanel.offsetWidth - reportPanel.scrollWidth) <= 10;
        this.touchAllowScroll = reportPanel.offsetWidth === reportPanel.scrollWidth;
        this.touchesLength++;
        if (this.touchAllowPageAction) {
            this.touchStartX = parseInt(e.changedTouches[0].clientX, 10);
            this.touchStartScrollY = reportPanel.scrollTop;
        }
    }
    eventTouchMove(e) {
        const reportPanel = this.model.controls.reportPanel.el.nativeElement;
        if (this.touchAllowPageAction) {
            this.lastTouches.shift();
            this.lastTouches.push({
                x: e.changedTouches[0].clientX,
                y: e.changedTouches[0].clientY,
                time: new Date().getTime()
            });
            if (this.touchAllowScroll && this.touchStartScrollY === reportPanel.scrollTop) {
                this.touchPosX = Math.trunc(this.lastTouches[1].x - this.touchStartX);
                if (scrollX === 0) {
                    this.element.nativeElement.style.transform = `translateX(${this.touchPosX}px)`;
                }
            }
        }
    }
    eventTouchEnd(e) {
        const reportPanel = this.model.controls.reportPanel.el.nativeElement;
        if (this.touchesLength > 0) {
            this.touchesLength--;
        }
        if (this.touchAllowPageAction && this.touchesLength === 0) {
            const dX = this.lastTouches[1].x - this.lastTouches[0].x;
            const dT = new Date().getTime() - this.lastTouches[1].time;
            if (this.touchStartScrollY !== reportPanel.scrollTop ||
                (dX <= 0 && this.model.reportParams.pageNumber >= this.model.reportParams.pagesCount - 1) ||
                (dX >= 0 && this.model.reportParams.pageNumber <= 0)) {
                this.translateX(0);
            }
            else if ((dX < -5 && dT <= 14 && this.lastTouches[1].x < this.touchStartX) ||
                (dX < 0 && this.touchPosX < -this.pageWidth / 3)) {
                this.controller.action({ name: 'NextPage' });
                this.translateX(-this.pageWidth);
            }
            else if ((dX > 5 && dT <= 14 && this.lastTouches[1].x > this.touchStartX) ||
                (dX > 0 && this.touchPosX > this.pageWidth / 3)) {
                this.controller.action({ name: 'PrevPage' });
                this.translateX(this.pageWidth);
            }
            else {
                this.translateX(0);
            }
        }
    }
    translateX(value) {
        this.element.nativeElement.style.transitionDuration = '300ms';
        this.element.nativeElement.style.transform = value === 0 ? '' : `translateX(${value}px)`;
        setTimeout(() => {
            this.element.nativeElement.style.transitionDuration = '';
        }, 300);
    }
};
PageComponent.ctorParameters = () => [
    { type: ModelService },
    { type: ControllerService }
];
__decorate([
    ViewChild('element')
], PageComponent.prototype, "element", void 0);
__decorate([
    Input()
], PageComponent.prototype, "pageAttributes", void 0);
__decorate([
    Input()
], PageComponent.prototype, "reportPanel", void 0);
PageComponent = __decorate([
    Component({
        selector: 'sti-page',
        template: `
    <div #element
      style="overflow: hidden; text-align: left; vertical-align: top; color: #000000; box-sizing: content-box; display:inline-block"
      [style.margin]="model.reportParams.viewMode === 'Continuous' ? '10px auto 10px auto' : '10px'"
      [style.display]="this.model.reportParams.viewMode === 'Continuous' ? 'table' : 'inline-block'"
      [style.border]="'1px solid ' + this.model.options.appearance.pageBorderColor"
      [style.background]="pageAttributes['background'] == 'Transparent' || pageAttributes.background == 'rgba(255,255,255,0)' ? 'White' : pageAttributes['background']"
      [style.padding]="pageAttributes['margins']"
      [style.width]="!pageAttributes['content'] ? pageWidth + 'px' : ''"
      [style.height]="!pageAttributes['content'] ? pageHeight + 'px' : ''"
      [class]="model.options.appearance.showPageShadow ? 'stiJsViewerPageShadow' : 'stiJsViewerPage'"
      (touchstart)="eventTouchStart($event)"
      (touchmove)="eventTouchMove($event)"
      (touchend)="eventTouchEnd($event)">
      </div>
  `
    })
], PageComponent);
export { PageComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9zdGltdWxzb2Z0LXZpZXdlci1hbmd1bGFyLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcGFnZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsS0FBSyxFQUFFLFNBQVMsRUFBNkIsTUFBTSxlQUFlLENBQUM7QUFDL0YsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXpELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBc0JuRSxJQUFhLGFBQWEsR0FBMUIsTUFBYSxhQUFhO0lBY3hCLFlBQW1CLEtBQW1CLEVBQVMsVUFBNkI7UUFBekQsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUFTLGVBQVUsR0FBVixVQUFVLENBQW1CO1FBUnBFLGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLGdCQUFXLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDakUseUJBQW9CLEdBQUcsS0FBSyxDQUFDO1FBQzdCLHFCQUFnQixHQUFHLEtBQUssQ0FBQztJQUsrQyxDQUFDO0lBRWpGLFFBQVE7SUFFUixDQUFDO0lBRUQsZUFBZTtRQUNiLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO1FBQ3hDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUM7UUFDN0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWhDLG9CQUFvQjtRQUNwQixJQUFJLElBQUksQ0FBQyxj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QXBCekIsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLFVBQVU7UUFDcEIsUUFBUSxFQUFFOzs7Ozs7Ozs7Ozs7Ozs7R0FlVDtLQUNGLENBQUM7R0FFVyxhQUFhLENBZ0t6QjtTQWhLWSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIElucHV0LCBWaWV3Q2hpbGQsIEVsZW1lbnRSZWYsIEFmdGVyVmlld0luaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTW9kZWxTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvbW9kZWwuc2VydmljZSc7XHJcbmltcG9ydCB7IFJlcG9ydFBhbmVsQ29tcG9uZW50IH0gZnJvbSAnLi9yZXBvcnQtcGFuZWwuY29tcG9uZW50JztcclxuaW1wb3J0IHsgQ29udHJvbGxlclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9jb250cm9sbGVyLnNlcnZpY2UnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdzdGktcGFnZScsXHJcbiAgdGVtcGxhdGU6IGBcclxuICAgIDxkaXYgI2VsZW1lbnRcclxuICAgICAgc3R5bGU9XCJvdmVyZmxvdzogaGlkZGVuOyB0ZXh0LWFsaWduOiBsZWZ0OyB2ZXJ0aWNhbC1hbGlnbjogdG9wOyBjb2xvcjogIzAwMDAwMDsgYm94LXNpemluZzogY29udGVudC1ib3g7IGRpc3BsYXk6aW5saW5lLWJsb2NrXCJcclxuICAgICAgW3N0eWxlLm1hcmdpbl09XCJtb2RlbC5yZXBvcnRQYXJhbXMudmlld01vZGUgPT09ICdDb250aW51b3VzJyA/ICcxMHB4IGF1dG8gMTBweCBhdXRvJyA6ICcxMHB4J1wiXHJcbiAgICAgIFtzdHlsZS5kaXNwbGF5XT1cInRoaXMubW9kZWwucmVwb3J0UGFyYW1zLnZpZXdNb2RlID09PSAnQ29udGludW91cycgPyAndGFibGUnIDogJ2lubGluZS1ibG9jaydcIlxyXG4gICAgICBbc3R5bGUuYm9yZGVyXT1cIicxcHggc29saWQgJyArIHRoaXMubW9kZWwub3B0aW9ucy5hcHBlYXJhbmNlLnBhZ2VCb3JkZXJDb2xvclwiXHJcbiAgICAgIFtzdHlsZS5iYWNrZ3JvdW5kXT1cInBhZ2VBdHRyaWJ1dGVzWydiYWNrZ3JvdW5kJ10gPT0gJ1RyYW5zcGFyZW50JyB8fCBwYWdlQXR0cmlidXRlcy5iYWNrZ3JvdW5kID09ICdyZ2JhKDI1NSwyNTUsMjU1LDApJyA/ICdXaGl0ZScgOiBwYWdlQXR0cmlidXRlc1snYmFja2dyb3VuZCddXCJcclxuICAgICAgW3N0eWxlLnBhZGRpbmddPVwicGFnZUF0dHJpYnV0ZXNbJ21hcmdpbnMnXVwiXHJcbiAgICAgIFtzdHlsZS53aWR0aF09XCIhcGFnZUF0dHJpYnV0ZXNbJ2NvbnRlbnQnXSA/IHBhZ2VXaWR0aCArICdweCcgOiAnJ1wiXHJcbiAgICAgIFtzdHlsZS5oZWlnaHRdPVwiIXBhZ2VBdHRyaWJ1dGVzWydjb250ZW50J10gPyBwYWdlSGVpZ2h0ICsgJ3B4JyA6ICcnXCJcclxuICAgICAgW2NsYXNzXT1cIm1vZGVsLm9wdGlvbnMuYXBwZWFyYW5jZS5zaG93UGFnZVNoYWRvdyA/ICdzdGlKc1ZpZXdlclBhZ2VTaGFkb3cnIDogJ3N0aUpzVmlld2VyUGFnZSdcIlxyXG4gICAgICAodG91Y2hzdGFydCk9XCJldmVudFRvdWNoU3RhcnQoJGV2ZW50KVwiXHJcbiAgICAgICh0b3VjaG1vdmUpPVwiZXZlbnRUb3VjaE1vdmUoJGV2ZW50KVwiXHJcbiAgICAgICh0b3VjaGVuZCk9XCJldmVudFRvdWNoRW5kKCRldmVudClcIj5cclxuICAgICAgPC9kaXY+XHJcbiAgYFxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIFBhZ2VDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQge1xyXG5cclxuICBAVmlld0NoaWxkKCdlbGVtZW50JykgZWxlbWVudDogRWxlbWVudFJlZjtcclxuICBASW5wdXQoKSBwYWdlQXR0cmlidXRlczogYW55O1xyXG4gIEBJbnB1dCgpIHJlcG9ydFBhbmVsOiBSZXBvcnRQYW5lbENvbXBvbmVudDtcclxuXHJcbiAgcHJpdmF0ZSB0b3VjaGVzTGVuZ3RoID0gMDtcclxuICBwcml2YXRlIGxhc3RUb3VjaGVzID0gW3sgeDogMCwgeTogMCwgdGltZTogMCB9LCB7IHg6IDAsIHk6IDAsIHRpbWU6IDAgfV07XHJcbiAgcHJpdmF0ZSB0b3VjaEFsbG93UGFnZUFjdGlvbiA9IGZhbHNlO1xyXG4gIHByaXZhdGUgdG91Y2hBbGxvd1Njcm9sbCA9IGZhbHNlO1xyXG4gIHByaXZhdGUgdG91Y2hTdGFydFg6IG51bWJlcjtcclxuICBwcml2YXRlIHRvdWNoU3RhcnRTY3JvbGxZOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSB0b3VjaFBvc1g6IG51bWJlcjtcclxuXHJcbiAgY29uc3RydWN0b3IocHVibGljIG1vZGVsOiBNb2RlbFNlcnZpY2UsIHB1YmxpYyBjb250cm9sbGVyOiBDb250cm9sbGVyU2VydmljZSkgeyB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG5cclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgIGNvbnN0IHBhZ2UgPSB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcclxuICAgIHBhZ2UuaW5uZXJIVE1MID0gdGhpcy5wYWdlQXR0cmlidXRlcy5jb250ZW50O1xyXG4gICAgdGhpcy5wYWdlQXR0cmlidXRlcy5wYWdlID0gcGFnZTtcclxuXHJcbiAgICAvLyBDb3JyZWN0IFdhdGVybWFya1xyXG4gICAgaWYgKHRoaXMucGFnZUF0dHJpYnV0ZXMuZXhpc3RzV2F0ZXJtYXJrKSB7XHJcbiAgICAgIHBhZ2Uuc3R5bGUucG9zaXRpb24gPSAncmVsYXRpdmUnO1xyXG4gICAgICBmb3IgKGNvbnN0IGNoaWxkTm9kZSBvZiBwYWdlLmNoaWxkTm9kZXMpIHtcclxuICAgICAgICBpZiAoY2hpbGROb2RlLmNsYXNzTmFtZSA9PT0gJ3N0aVdhdGVybWFya0ltYWdlJykge1xyXG4gICAgICAgICAgY2hpbGROb2RlLnN0eWxlLndpZHRoID0gJ2F1dG8nO1xyXG4gICAgICAgICAgY2hpbGROb2RlLnN0eWxlLmhlaWdodCA9ICdhdXRvJztcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLm1vZGVsLm9wdGlvbnMuYXBwZWFyYW5jZS5yZXBvcnREaXNwbGF5TW9kZSA9PT0gJ0RpdicgfHwgdGhpcy5tb2RlbC5vcHRpb25zLmFwcGVhcmFuY2UucmVwb3J0RGlzcGxheU1vZGUgPT09ICdTcGFuJykge1xyXG4gICAgICBjb25zdCBjaGlsZHMgPSBwYWdlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ1N0aVBhZ2VDb250YWluZXInKTtcclxuICAgICAgaWYgKGNoaWxkcyAmJiBjaGlsZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnN0IHBhZ2VDb250YWluZXIgPSBjaGlsZHNbMF07XHJcbiAgICAgICAgcGFnZUNvbnRhaW5lci5zdHlsZS5wb3NpdGlvbiA9ICdyZWxhdGl2ZSc7XHJcbiAgICAgICAgaWYgKHRoaXMubW9kZWwub3B0aW9ucy5hcHBlYXJhbmNlLnJlcG9ydERpc3BsYXlNb2RlID09PSAnU3BhbicpIHtcclxuICAgICAgICAgIHBhZ2VDb250YWluZXIuc3R5bGUubWFyZ2luID0gJzAgMXB4JzsgLy8gZml4IENocm9tZSBidWcgd2l0aCBTUEFOIHBvc2l0aW9uXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBhZ2Uuc3R5bGUud2lkdGggPSAocGFnZS5wYWdlV2lkdGggLSBwYWdlLm1hcmdpbnNbMV0gLSBwYWdlLm1hcmdpbnNbM10pICsgJ3B4JztcclxuICAgICAgICBwYWdlLnN0eWxlLmhlaWdodCA9IChwYWdlLnBhZ2VIZWlnaHQgLSBwYWdlLm1hcmdpbnNbMF0gLSBwYWdlLm1hcmdpbnNbMl0pICsgJ3B4JztcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LnBhZ2VBdHRyaWJ1dGVzID0gdGhpcy5wYWdlQXR0cmlidXRlcztcclxuXHJcbiAgICAvKmNvbnN0IHBhZ2VIZWlnaHQgPSB0aGlzLnBhZ2VIZWlnaHQ7XHJcbiAgICBpZiAocGFnZUhlaWdodCAhPT0gMCkge1xyXG4gICAgICAvLyBmaXhlZCBidWcgd2l0aCBsb25nIHRpbWUgZXhlY3V0ZVxyXG4gICAgICBpZiAodGhpcy5tb2RlbC5vcHRpb25zLmFwcGVhcmFuY2UucmVwb3J0RGlzcGxheU1vZGUgIT09ICdUYWJsZScgJiYgdGhpcy5tb2RlbC5yZXBvcnRQYXJhbXMudmlld01vZGUgIT09ICdTaW5nbGVQYWdlJykge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgY3VycmVudFBhZ2VIZWlnaHQgPSBwYWdlLm9mZnNldEhlaWdodCAtIHRoaXMubWFyZ2luc1swXSAtIHRoaXMubWFyZ2luc1syXTtcclxuICAgICAgICAgIGlmICh0aGlzLnJlcG9ydFBhbmVsLm1heEhlaWdodHNbcGFnZUhlaWdodF0gPT0gbnVsbCB8fCBjdXJyZW50UGFnZUhlaWdodCA+IHRoaXMucmVwb3J0UGFuZWwubWF4SGVpZ2h0c1twYWdlSGVpZ2h0XSkge1xyXG4gICAgICAgICAgICB0aGlzLnJlcG9ydFBhbmVsLm1heEhlaWdodHNbcGFnZUhlaWdodF0gPSBjdXJyZW50UGFnZUhlaWdodDtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBjdXJyZW50UGFnZUhlaWdodCA9IHBhZ2Uub2Zmc2V0SGVpZ2h0IC0gdGhpcy5tYXJnaW5zWzBdIC0gdGhpcy5tYXJnaW5zWzJdO1xyXG4gICAgICAgIGlmICh0aGlzLnJlcG9ydFBhbmVsLm1heEhlaWdodHNbcGFnZUhlaWdodF0gPT09IG51bGwgfHwgY3VycmVudFBhZ2VIZWlnaHQgPiB0aGlzLnJlcG9ydFBhbmVsLm1heEhlaWdodHNbcGFnZUhlaWdodF0pIHtcclxuICAgICAgICAgIHRoaXMucmVwb3J0UGFuZWwubWF4SGVpZ2h0c1twYWdlSGVpZ2h0XSA9IGN1cnJlbnRQYWdlSGVpZ2h0O1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSovXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IG1hcmdpbnMoKTogbnVtYmVyW10ge1xyXG4gICAgY29uc3QgbWFyZ2lucyA9IFswLCAwLCAwLCAwXTtcclxuICAgIGlmICh0aGlzLnBhZ2VBdHRyaWJ1dGVzLm1hcmdpbnMpIHtcclxuICAgICAgY29uc3QgbWFyZ2luc1B4ID0gdGhpcy5wYWdlQXR0cmlidXRlcy5tYXJnaW5zLnNwbGl0KCcgJyk7XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWFyZ2luc1B4Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgbWFyZ2luc1tpXSA9IHBhcnNlSW50KG1hcmdpbnNQeFtpXS5yZXBsYWNlKCdweCcsICcnKSwgMTApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbWFyZ2lucztcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXQgcGFnZVdpZHRoKCk6IG51bWJlciB7XHJcbiAgICBjb25zdCBwYWdlU2l6ZXM6IHN0cmluZ1tdID0gdGhpcy5wYWdlQXR0cmlidXRlcy5zaXplcyA/IHRoaXMucGFnZUF0dHJpYnV0ZXMuc2l6ZXMuc3BsaXQoJzsnKSA6IG51bGw7XHJcbiAgICBpZiAocGFnZVNpemVzKSB7XHJcbiAgICAgIHJldHVybiBwYXJzZUludChwYWdlU2l6ZXNbMF0sIDEwKTtcclxuICAgIH1cclxuICAgIHJldHVybiAwO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldCBwYWdlSGVpZ2h0KCk6IG51bWJlciB7XHJcbiAgICBjb25zdCBwYWdlU2l6ZXM6IHN0cmluZ1tdID0gdGhpcy5wYWdlQXR0cmlidXRlcy5zaXplcyA/IHRoaXMucGFnZUF0dHJpYnV0ZXMuc2l6ZXMuc3BsaXQoJzsnKSA6IG51bGw7XHJcbiAgICBpZiAocGFnZVNpemVzKSB7XHJcbiAgICAgIHJldHVybiBwYXJzZUludChwYWdlU2l6ZXNbMV0sIDEwKTtcclxuICAgIH1cclxuICAgIHJldHVybiAwO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGV2ZW50VG91Y2hTdGFydChlOiBhbnkpIHtcclxuICAgIGNvbnN0IHJlcG9ydFBhbmVsID0gdGhpcy5tb2RlbC5jb250cm9scy5yZXBvcnRQYW5lbC5lbC5uYXRpdmVFbGVtZW50O1xyXG4gICAgdGhpcy50b3VjaEFsbG93UGFnZUFjdGlvbiA9IHRoaXMudG91Y2hlc0xlbmd0aCA9PT0gMCAmJiBNYXRoLmFicyhyZXBvcnRQYW5lbC5vZmZzZXRXaWR0aCAtIHJlcG9ydFBhbmVsLnNjcm9sbFdpZHRoKSA8PSAxMDtcclxuICAgIHRoaXMudG91Y2hBbGxvd1Njcm9sbCA9IHJlcG9ydFBhbmVsLm9mZnNldFdpZHRoID09PSByZXBvcnRQYW5lbC5zY3JvbGxXaWR0aDtcclxuICAgIHRoaXMudG91Y2hlc0xlbmd0aCsrO1xyXG5cclxuICAgIGlmICh0aGlzLnRvdWNoQWxsb3dQYWdlQWN0aW9uKSB7XHJcbiAgICAgIHRoaXMudG91Y2hTdGFydFggPSBwYXJzZUludChlLmNoYW5nZWRUb3VjaGVzWzBdLmNsaWVudFgsIDEwKTtcclxuICAgICAgdGhpcy50b3VjaFN0YXJ0U2Nyb2xsWSA9IHJlcG9ydFBhbmVsLnNjcm9sbFRvcDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBldmVudFRvdWNoTW92ZShlOiBhbnkpIHtcclxuICAgIGNvbnN0IHJlcG9ydFBhbmVsID0gdGhpcy5tb2RlbC5jb250cm9scy5yZXBvcnRQYW5lbC5lbC5uYXRpdmVFbGVtZW50O1xyXG4gICAgaWYgKHRoaXMudG91Y2hBbGxvd1BhZ2VBY3Rpb24pIHtcclxuICAgICAgdGhpcy5sYXN0VG91Y2hlcy5zaGlmdCgpO1xyXG4gICAgICB0aGlzLmxhc3RUb3VjaGVzLnB1c2goe1xyXG4gICAgICAgIHg6IGUuY2hhbmdlZFRvdWNoZXNbMF0uY2xpZW50WCxcclxuICAgICAgICB5OiBlLmNoYW5nZWRUb3VjaGVzWzBdLmNsaWVudFksXHJcbiAgICAgICAgdGltZTogbmV3IERhdGUoKS5nZXRUaW1lKClcclxuICAgICAgfSk7XHJcbiAgICAgIGlmICh0aGlzLnRvdWNoQWxsb3dTY3JvbGwgJiYgdGhpcy50b3VjaFN0YXJ0U2Nyb2xsWSA9PT0gcmVwb3J0UGFuZWwuc2Nyb2xsVG9wKSB7XHJcbiAgICAgICAgdGhpcy50b3VjaFBvc1ggPSBNYXRoLnRydW5jKHRoaXMubGFzdFRvdWNoZXNbMV0ueCAtIHRoaXMudG91Y2hTdGFydFgpO1xyXG4gICAgICAgIGlmIChzY3JvbGxYID09PSAwKSB7XHJcbiAgICAgICAgICB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlWCgke3RoaXMudG91Y2hQb3NYfXB4KWA7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZXZlbnRUb3VjaEVuZChlOiBhbnkpIHtcclxuICAgIGNvbnN0IHJlcG9ydFBhbmVsID0gdGhpcy5tb2RlbC5jb250cm9scy5yZXBvcnRQYW5lbC5lbC5uYXRpdmVFbGVtZW50O1xyXG4gICAgaWYgKHRoaXMudG91Y2hlc0xlbmd0aCA+IDApIHsgdGhpcy50b3VjaGVzTGVuZ3RoLS07IH1cclxuICAgIGlmICh0aGlzLnRvdWNoQWxsb3dQYWdlQWN0aW9uICYmIHRoaXMudG91Y2hlc0xlbmd0aCA9PT0gMCkge1xyXG4gICAgICBjb25zdCBkWCA9IHRoaXMubGFzdFRvdWNoZXNbMV0ueCAtIHRoaXMubGFzdFRvdWNoZXNbMF0ueDtcclxuICAgICAgY29uc3QgZFQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHRoaXMubGFzdFRvdWNoZXNbMV0udGltZTtcclxuXHJcbiAgICAgIGlmICh0aGlzLnRvdWNoU3RhcnRTY3JvbGxZICE9PSByZXBvcnRQYW5lbC5zY3JvbGxUb3AgfHxcclxuICAgICAgICAoZFggPD0gMCAmJiB0aGlzLm1vZGVsLnJlcG9ydFBhcmFtcy5wYWdlTnVtYmVyID49IHRoaXMubW9kZWwucmVwb3J0UGFyYW1zLnBhZ2VzQ291bnQgLSAxKSB8fFxyXG4gICAgICAgIChkWCA+PSAwICYmIHRoaXMubW9kZWwucmVwb3J0UGFyYW1zLnBhZ2VOdW1iZXIgPD0gMCkpIHtcclxuICAgICAgICB0aGlzLnRyYW5zbGF0ZVgoMCk7XHJcbiAgICAgIH0gZWxzZSBpZiAoKGRYIDwgLTUgJiYgZFQgPD0gMTQgJiYgdGhpcy5sYXN0VG91Y2hlc1sxXS54IDwgdGhpcy50b3VjaFN0YXJ0WCkgfHxcclxuICAgICAgICAoZFggPCAwICYmIHRoaXMudG91Y2hQb3NYIDwgLXRoaXMucGFnZVdpZHRoIC8gMykpIHtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuYWN0aW9uKHsgbmFtZTogJ05leHRQYWdlJyB9KTtcclxuICAgICAgICB0aGlzLnRyYW5zbGF0ZVgoLXRoaXMucGFnZVdpZHRoKTtcclxuICAgICAgfSBlbHNlIGlmICgoZFggPiA1ICYmIGRUIDw9IDE0ICYmIHRoaXMubGFzdFRvdWNoZXNbMV0ueCA+IHRoaXMudG91Y2hTdGFydFgpIHx8XHJcbiAgICAgICAgKGRYID4gMCAmJiB0aGlzLnRvdWNoUG9zWCA+IHRoaXMucGFnZVdpZHRoIC8gMykpIHtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuYWN0aW9uKHsgbmFtZTogJ1ByZXZQYWdlJyB9KTtcclxuICAgICAgICB0aGlzLnRyYW5zbGF0ZVgodGhpcy5wYWdlV2lkdGgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMudHJhbnNsYXRlWCgwKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHRyYW5zbGF0ZVgodmFsdWU6IG51bWJlcikge1xyXG4gICAgdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuc3R5bGUudHJhbnNpdGlvbkR1cmF0aW9uID0gJzMwMG1zJztcclxuICAgIHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LnN0eWxlLnRyYW5zZm9ybSA9IHZhbHVlID09PSAwID8gJycgOiBgdHJhbnNsYXRlWCgke3ZhbHVlfXB4KWA7XHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuc3R5bGUudHJhbnNpdGlvbkR1cmF0aW9uID0gJyc7XHJcbiAgICB9LCAzMDApO1xyXG4gIH1cclxufVxyXG4iXX0=