import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { ModelService } from './model.service';
import { HelperService } from './helper.service';
import { AnimationService } from './animation.service';
let FindService = class FindService {
    constructor(model, helper, animationService) {
        this.model = model;
        this.helper = helper;
        this.animationService = animationService;
        this.symbols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890';
        this.findLabels = [];
        this.text = '';
        this.lastFindText = '';
        this.matchCase = false;
        this.matchWholeWord = false;
        this.findMode = false;
        model.controls.findPanel.getVisibility().subscribe((value) => {
            if (!value) {
                this.hideFindLabels();
                this.lastFindText = '';
            }
        });
    }
    hideFindLabels() {
        this.findLabels.forEach((findLabel) => {
            const parentElement = findLabel.parentElement;
            parentElement.removeChild(findLabel);
            if (parentElement.oldPositionStyle) {
                parentElement.style.position = parentElement.oldPositionStyle;
            }
        });
        this.findLabels = [];
        this.findMode = false;
        this.lastFindText = '';
    }
    selectFindLabel(direction) {
        if (this.findLabels.length === 0) {
            return;
        }
        let selectedIndex = 0;
        const labels = this.findLabels;
        for (let i = 0; i < labels.length; i++) {
            if (labels[i].isSelected) {
                labels[i].setSelected(false);
                selectedIndex = i;
                break;
            }
        }
        if (direction === 'Next') {
            selectedIndex++;
            if (selectedIndex > labels.length - 1) {
                selectedIndex = 0;
            }
        }
        else {
            selectedIndex--;
            if (selectedIndex < 0) {
                selectedIndex = labels.length - 1;
            }
        }
        labels[selectedIndex].setSelected(true);
        this.goToFindedElement(labels[selectedIndex]);
    }
    showFindLabels() {
        this.hideFindLabels();
        this.findMode = true;
        this.lastFindText = this.text;
        const text = this.matchCase ? this.text : this.text.toLowerCase();
        this.model.pages.forEach(page => {
            const pageElements = page.page.getElementsByTagName('*');
            for (const pageElement of pageElements) {
                let innerText = pageElement.innerHTML;
                if (innerText && pageElement.childNodes.length === 1 && pageElement.childNodes[0].nodeName === '#text') {
                    if (!this.matchCase) {
                        innerText = innerText.toLowerCase();
                    }
                    if (innerText.indexOf(text) >= 0) {
                        if (this.matchWholeWord && !this.isWholeWord(innerText, text)) {
                            continue;
                        }
                        const label = document.createElement('div');
                        label.ownerElement = pageElement;
                        label.className = 'stiJsViewerFindLabel';
                        label.style.width = (pageElement.offsetWidth - 4) + 'px';
                        const labelHeight = pageElement.offsetHeight - 4;
                        label.style.height = labelHeight + 'px';
                        label.style.top = '0px';
                        label.style.left = '0px';
                        label.ownerElement.oldPositionStyle = label.ownerElement.style.position;
                        if (label.ownerElement.style.position !== 'absolute' && label.ownerElement.style.position !== 'fixed') {
                            label.ownerElement.style.position = 'relative';
                        }
                        pageElement.insertBefore(label, pageElement.childNodes[0]);
                        label.setSelected = function (state) {
                            this.isSelected = state;
                            this.style.border = '2px solid ' + (state ? 'red' : '#8a8a8a');
                        };
                        if (this.findLabels.length === 0) {
                            label.setSelected(true);
                        }
                        this.findLabels.push(label);
                    }
                }
            }
        });
        if (this.findLabels.length > 0) {
            this.goToFindedElement(this.findLabels[0]);
        }
    }
    goToFindedElement(findLabel) {
        if (findLabel && findLabel.ownerElement) {
            const targetTop = this.helper.findPosY(findLabel.ownerElement, this.model.options.appearance.scrollbarsMode ? 'stiJsViewerReportPanel' : null, true) - findLabel.ownerElement.offsetHeight - 50;
            const d = new Date();
            const endTime = d.getTime() + this.model.options.scrollDuration;
            this.animationService.showAnimationForScroll(this.model.controls.reportPanel.el.nativeElement, targetTop, endTime, () => { });
        }
    }
    isWholeWord(str, word) {
        const index = str.indexOf(word);
        const preSymbol = str.substring(index - 1, index);
        const nextSymbol = str.substring(index + word.length, index + word.length + 1);
        return ((preSymbol === '' || this.symbols.indexOf(preSymbol) === -1) && (nextSymbol === '' || this.symbols.indexOf(nextSymbol) === -1));
    }
};
FindService.ctorParameters = () => [
    { type: ModelService },
    { type: HelperService },
    { type: AnimationService }
];
FindService = __decorate([
    Injectable()
], FindService);
export { FindService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmluZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vc3RpbXVsc29mdC12aWV3ZXItYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9maW5kLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd2RCxJQUFhLFdBQVcsR0FBeEIsTUFBYSxXQUFXO0lBV3RCLFlBQW9CLEtBQW1CLEVBQVUsTUFBcUIsRUFBVSxnQkFBa0M7UUFBOUYsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUFVLFdBQU0sR0FBTixNQUFNLENBQWU7UUFBVSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBVDFHLFlBQU8sR0FBRyxnRUFBZ0UsQ0FBQztRQUMzRSxlQUFVLEdBQVUsRUFBRSxDQUFDO1FBRXhCLFNBQUksR0FBRyxFQUFFLENBQUM7UUFDVixpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUNsQixjQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ2xCLG1CQUFjLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFHdEIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDM0QsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDVixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO2FBQ3hCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sY0FBYztRQUNuQixJQUFJLENBQUMs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Q0FBQyxjQUFjLENBQUM7WUFDaEUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsYUFBYSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDL0g7SUFDSCxDQUFDO0lBRUQsV0FBVyxDQUFDLEdBQVcsRUFBRSxJQUFZO1FBQ25DLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEMsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2xELE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFL0UsT0FBTyxDQUFDLENBQUMsU0FBUyxLQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxLQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDMUksQ0FBQztDQUNGLENBQUE7O1lBdEg0QixZQUFZO1lBQWtCLGFBQWE7WUFBNEIsZ0JBQWdCOztBQVh2RyxXQUFXO0lBRHZCLFVBQVUsRUFBRTtHQUNBLFdBQVcsQ0FpSXZCO1NBaklZLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1vZGVsU2VydmljZSB9IGZyb20gJy4vbW9kZWwuc2VydmljZSc7XHJcbmltcG9ydCB7IEhlbHBlclNlcnZpY2UgfSBmcm9tICcuL2hlbHBlci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQW5pbWF0aW9uU2VydmljZSB9IGZyb20gJy4vYW5pbWF0aW9uLnNlcnZpY2UnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRmluZFNlcnZpY2Uge1xyXG5cclxuICBwcml2YXRlIHN5bWJvbHMgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejEyMzQ1Njc4OTAnO1xyXG4gIHByaXZhdGUgZmluZExhYmVsczogYW55W10gPSBbXTtcclxuXHJcbiAgcHVibGljIHRleHQgPSAnJztcclxuICBwdWJsaWMgbGFzdEZpbmRUZXh0ID0gJyc7XHJcbiAgcHVibGljIG1hdGNoQ2FzZSA9IGZhbHNlO1xyXG4gIHB1YmxpYyBtYXRjaFdob2xlV29yZCA9IGZhbHNlO1xyXG4gIHB1YmxpYyBmaW5kTW9kZSA9IGZhbHNlO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG1vZGVsOiBNb2RlbFNlcnZpY2UsIHByaXZhdGUgaGVscGVyOiBIZWxwZXJTZXJ2aWNlLCBwcml2YXRlIGFuaW1hdGlvblNlcnZpY2U6IEFuaW1hdGlvblNlcnZpY2UpIHtcclxuICAgIG1vZGVsLmNvbnRyb2xzLmZpbmRQYW5lbC5nZXRWaXNpYmlsaXR5KCkuc3Vic2NyaWJlKCh2YWx1ZSkgPT4ge1xyXG4gICAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy5oaWRlRmluZExhYmVscygpO1xyXG4gICAgICAgIHRoaXMubGFzdEZpbmRUZXh0ID0gJyc7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGhpZGVGaW5kTGFiZWxzKCkge1xyXG4gICAgdGhpcy5maW5kTGFiZWxzLmZvckVhY2goKGZpbmRMYWJlbCkgPT4ge1xyXG4gICAgICBjb25zdCBwYXJlbnRFbGVtZW50ID0gZmluZExhYmVsLnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgIHBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoZmluZExhYmVsKTtcclxuICAgICAgaWYgKHBhcmVudEVsZW1lbnQub2xkUG9zaXRpb25TdHlsZSkge1xyXG4gICAgICAgIHBhcmVudEVsZW1lbnQuc3R5bGUucG9zaXRpb24gPSBwYXJlbnRFbGVtZW50Lm9sZFBvc2l0aW9uU3R5bGU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuZmluZExhYmVscyA9IFtdO1xyXG4gICAgdGhpcy5maW5kTW9kZSA9IGZhbHNlO1xyXG4gICAgdGhpcy5sYXN0RmluZFRleHQgPSAnJztcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzZWxlY3RGaW5kTGFiZWwoZGlyZWN0aW9uOiBzdHJpbmcpIHtcclxuICAgIGlmICh0aGlzLmZpbmRMYWJlbHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCBzZWxlY3RlZEluZGV4ID0gMDtcclxuICAgIGNvbnN0IGxhYmVscyA9IHRoaXMuZmluZExhYmVscztcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGFiZWxzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGlmIChsYWJlbHNbaV0uaXNTZWxlY3RlZCkge1xyXG4gICAgICAgIGxhYmVsc1tpXS5zZXRTZWxlY3RlZChmYWxzZSk7XHJcbiAgICAgICAgc2VsZWN0ZWRJbmRleCA9IGk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChkaXJlY3Rpb24gPT09ICdOZXh0Jykge1xyXG4gICAgICBzZWxlY3RlZEluZGV4Kys7XHJcbiAgICAgIGlmIChzZWxlY3RlZEluZGV4ID4gbGFiZWxzLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICBzZWxlY3RlZEluZGV4ID0gMDtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc2VsZWN0ZWRJbmRleC0tO1xyXG4gICAgICBpZiAoc2VsZWN0ZWRJbmRleCA8IDApIHtcclxuICAgICAgICBzZWxlY3RlZEluZGV4ID0gbGFiZWxzLmxlbmd0aCAtIDE7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGxhYmVsc1tzZWxlY3RlZEluZGV4XS5zZXRTZWxlY3RlZCh0cnVlKTtcclxuICAgIHRoaXMuZ29Ub0ZpbmRlZEVsZW1lbnQobGFiZWxzW3NlbGVjdGVkSW5kZXhdKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaG93RmluZExhYmVscygpIHtcclxuICAgIHRoaXMuaGlkZUZpbmRMYWJlbHMoKTtcclxuICAgIHRoaXMuZmluZE1vZGUgPSB0cnVlO1xyXG4gICAgdGhpcy5sYXN0RmluZFRleHQgPSB0aGlzLnRleHQ7XHJcbiAgICBjb25zdCB0ZXh0ID0gdGhpcy5tYXRjaENhc2UgPyB0aGlzLnRleHQgOiB0aGlzLnRleHQudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICB0aGlzLm1vZGVsLnBhZ2VzLmZvckVhY2gocGFnZSA9PiB7XHJcbiAgICAgIGNvbnN0IHBhZ2VFbGVtZW50cyA9IHBhZ2UucGFnZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpO1xyXG4gICAgICBmb3IgKGNvbnN0IHBhZ2VFbGVtZW50IG9mIHBhZ2VFbGVtZW50cykge1xyXG4gICAgICAgIGxldCBpbm5lclRleHQgPSBwYWdlRWxlbWVudC5pbm5lckhUTUw7XHJcbiAgICAgICAgaWYgKGlubmVyVGV4dCAmJiBwYWdlRWxlbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSAmJiBwYWdlRWxlbWVudC5jaGlsZE5vZGVzWzBdLm5vZGVOYW1lID09PSAnI3RleHQnKSB7XHJcbiAgICAgICAgICBpZiAoIXRoaXMubWF0Y2hDYXNlKSB7XHJcbiAgICAgICAgICAgIGlubmVyVGV4dCA9IGlubmVyVGV4dC50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKGlubmVyVGV4dC5pbmRleE9mKHRleHQpID49IDApIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMubWF0Y2hXaG9sZVdvcmQgJiYgIXRoaXMuaXNXaG9sZVdvcmQoaW5uZXJUZXh0LCB0ZXh0KSkge1xyXG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGxhYmVsOiBhbnkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgbGFiZWwub3duZXJFbGVtZW50ID0gcGFnZUVsZW1lbnQ7XHJcbiAgICAgICAgICAgIGxhYmVsLmNsYXNzTmFtZSA9ICdzdGlKc1ZpZXdlckZpbmRMYWJlbCc7XHJcbiAgICAgICAgICAgIGxhYmVsLnN0eWxlLndpZHRoID0gKHBhZ2VFbGVtZW50Lm9mZnNldFdpZHRoIC0gNCkgKyAncHgnO1xyXG4gICAgICAgICAgICBjb25zdCBsYWJlbEhlaWdodCA9IHBhZ2VFbGVtZW50Lm9mZnNldEhlaWdodCAtIDQ7XHJcbiAgICAgICAgICAgIGxhYmVsLnN0eWxlLmhlaWdodCA9IGxhYmVsSGVpZ2h0ICsgJ3B4JztcclxuICAgICAgICAgICAgbGFiZWwuc3R5bGUudG9wID0gJzBweCc7XHJcbiAgICAgICAgICAgIGxhYmVsLnN0eWxlLmxlZnQgPSAnMHB4JztcclxuICAgICAgICAgICAgbGFiZWwub3duZXJFbGVtZW50Lm9sZFBvc2l0aW9uU3R5bGUgPSBsYWJlbC5vd25lckVsZW1lbnQuc3R5bGUucG9zaXRpb247XHJcbiAgICAgICAgICAgIGlmIChsYWJlbC5vd25lckVsZW1lbnQuc3R5bGUucG9zaXRpb24gIT09ICdhYnNvbHV0ZScgJiYgbGFiZWwub3duZXJFbGVtZW50LnN0eWxlLnBvc2l0aW9uICE9PSAnZml4ZWQnKSB7XHJcbiAgICAgICAgICAgICAgbGFiZWwub3duZXJFbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ3JlbGF0aXZlJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwYWdlRWxlbWVudC5pbnNlcnRCZWZvcmUobGFiZWwsIHBhZ2VFbGVtZW50LmNoaWxkTm9kZXNbMF0pO1xyXG5cclxuICAgICAgICAgICAgbGFiZWwuc2V0U2VsZWN0ZWQgPSBmdW5jdGlvbiAoc3RhdGUpIHtcclxuICAgICAgICAgICAgICB0aGlzLmlzU2VsZWN0ZWQgPSBzdGF0ZTtcclxuICAgICAgICAgICAgICB0aGlzLnN0eWxlLmJvcmRlciA9ICcycHggc29saWQgJyArIChzdGF0ZSA/ICdyZWQnIDogJyM4YThhOGEnKTtcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZpbmRMYWJlbHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgbGFiZWwuc2V0U2VsZWN0ZWQodHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5maW5kTGFiZWxzLnB1c2gobGFiZWwpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHRoaXMuZmluZExhYmVscy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIHRoaXMuZ29Ub0ZpbmRlZEVsZW1lbnQodGhpcy5maW5kTGFiZWxzWzBdKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdvVG9GaW5kZWRFbGVtZW50KGZpbmRMYWJlbDogYW55KSB7XHJcbiAgICBpZiAoZmluZExhYmVsICYmIGZpbmRMYWJlbC5vd25lckVsZW1lbnQpIHtcclxuICAgICAgY29uc3QgdGFyZ2V0VG9wID0gdGhpcy5oZWxwZXIuZmluZFBvc1koZmluZExhYmVsLm93bmVyRWxlbWVudCwgdGhpcy5tb2RlbC5vcHRpb25zLmFwcGVhcmFuY2Uuc2Nyb2xsYmFyc01vZGUgPyAnc3RpSnNWaWV3ZXJSZXBvcnRQYW5lbCcgOiBudWxsLCB0cnVlKSAtIGZpbmRMYWJlbC5vd25lckVsZW1lbnQub2Zmc2V0SGVpZ2h0IC0gNTA7XHJcbiAgICAgIGNvbnN0IGQgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICBjb25zdCBlbmRUaW1lID0gZC5nZXRUaW1lKCkgKyB0aGlzLm1vZGVsLm9wdGlvbnMuc2Nyb2xsRHVyYXRpb247XHJcbiAgICAgIHRoaXMuYW5pbWF0aW9uU2VydmljZS5zaG93QW5pbWF0aW9uRm9yU2Nyb2xsKHRoaXMubW9kZWwuY29udHJvbHMucmVwb3J0UGFuZWwuZWwubmF0aXZlRWxlbWVudCwgdGFyZ2V0VG9wLCBlbmRUaW1lLCAoKSA9PiB7IH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaXNXaG9sZVdvcmQoc3RyOiBzdHJpbmcsIHdvcmQ6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgaW5kZXggPSBzdHIuaW5kZXhPZih3b3JkKTtcclxuICAgIGNvbnN0IHByZVN5bWJvbCA9IHN0ci5zdWJzdHJpbmcoaW5kZXggLSAxLCBpbmRleCk7XHJcbiAgICBjb25zdCBuZXh0U3ltYm9sID0gc3RyLnN1YnN0cmluZyhpbmRleCArIHdvcmQubGVuZ3RoLCBpbmRleCArIHdvcmQubGVuZ3RoICsgMSk7XHJcblxyXG4gICAgcmV0dXJuICgocHJlU3ltYm9sID09PSAnJyB8fCB0aGlzLnN5bWJvbHMuaW5kZXhPZihwcmVTeW1ib2wpID09PSAtMSkgJiYgKG5leHRTeW1ib2wgPT09ICcnIHx8IHRoaXMuc3ltYm9scy5pbmRleE9mKG5leHRTeW1ib2wpID09PSAtMSkpO1xyXG4gIH1cclxufVxyXG4iXX0=