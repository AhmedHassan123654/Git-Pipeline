import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { HelperService } from '../services/helper.service';
import { ModelService } from '../services/model.service';
import { MouseService } from '../services/mouse.service';
import { Subject } from 'rxjs';
export class Menu {
    constructor(name, items, parent, type, state, menuEl, top, left, innerContent, width, height, menuStyleName, params, verticalItems, action, itemStyleName, value, sizeStyle) {
        this.name = name;
        this.items = items;
        this.parent = parent;
        this.type = type;
        this.state = state;
        this.menuEl = menuEl;
        this.top = top;
        this.left = left;
        this.innerContent = innerContent;
        this.width = width;
        this.height = height;
        this.menuStyleName = menuStyleName;
        this.params = params;
        this.verticalItems = verticalItems;
        this.action = action;
        this.itemStyleName = itemStyleName;
        this.value = value;
        this.sizeStyle = sizeStyle;
    }
}
let MenuService = class MenuService {
    constructor(helper, model, mouseService) {
        this.helper = helper;
        this.model = model;
        this.mouseService = mouseService;
        this.VERTICAL_MENU_NAME = 'verticalMenu';
        this.menuMouseUp = '';
        this._menus = {};
        this.subject = new Subject();
        this.mouseService.getDocumentMouseUp().subscribe((event) => {
            if (this.menuMouseUp === '') {
                this.closeAllMenus();
            }
            else if (this.menuMouseUp !== 'datePickerMenu' && this.menuMouseUp !== this.VERTICAL_MENU_NAME) {
                const datePicker = Object.values(this._menus).find(m => m.type === 'datePickerMenu');
                if (datePicker != null) {
                    datePicker.state = 'initialDown';
                }
            }
            this.menuMouseUp = '';
        });
    }
    getVisibility() {
        return this.subject.asObservable();
    }
    addMenu(menu) {
        this._menus[menu.name] = menu;
    }
    closeAllMenus() {
        Object.values(this._menus).forEach((m) => m.state = m.type === 'buttonMenu' && this.model.options.isMobileDevice ? 'initialLeft' : 'initialDown');
    }
    isMenuVisible() {
        return Object.values(this._menus).find(m => m.state === 'expanded') != null;
    }
    showMenu(menuName) {
        var _a, _b;
        const menu = this._menus[menuName];
        if (((_a = menu) === null || _a === void 0 ? void 0 : _a.type) !== 'datePickerMenu' && ((_b = menu) === null || _b === void 0 ? void 0 : _b.type) !== this.VERTICAL_MENU_NAME) {
            this.closeAllMenus();
        }
        if (menu) {
            menu.sizeStyle = 'opacity: 0;';
            if (this.model.options.isMobileDevice && menu.type === 'buttonMenu') {
                setTimeout(() => {
                    const innerContent = menu.innerContent.nativeElement;
                    menu.left = 0;
                    menu.top = 0;
                    menu.width = innerContent.offsetWidth;
                    menu.height = innerContent.offsetHeight;
                    menu.state = 'initialLeft';
                    menu.sizeStyle = null;
                    setTimeout(() => {
                        menu.state = 'expanded';
                    });
                });
            }
            else {
                setTimeout(() => {
                    menu.sizeStyle = null;
                    this.showMenuInternal(menu);
                });
            }
            this.subject.next(menu);
        }
    }
    showMenuInternal(menu) {
        const isVertMenu = true;
        const parentButton = menu.parent.nativeElement;
        const innerContent = menu.innerContent.nativeElement;
        const offsetHeight = menu.menuEl.nativeElement.offsetHeight;
        const style = menu.menuEl.nativeElement.style;
        const coords = this.getMenuCoordinates(parentButton, innerContent, offsetHeight, style, isVertMenu);
        menu.left = coords.left;
        menu.top = coords.top;
        menu.width = menu.width || coords.width;
        menu.height = coords.height;
        menu.state = coords.state;
        setTimeout(() => {
            menu.state = 'expanded';
        });
    }
    getMenuCoordinates(parentButton, innerContent, offsetHeight, style, isVertMenu) {
        const menu = {};
        const browserWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
        const browserHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
        const rightAlign = false;
        const mainClassName = 'stiJsViewerMainPanel';
        let animDirect = 'Down';
        const leftOffset = 0;
        let left = (isVertMenu)
            ? (this.model.options.appearance.rightToLeft || rightAlign
                ? (this.helper.findPosX(parentButton, mainClassName) - innerContent.offsetWidth + parentButton.offsetWidth) - (leftOffset || 0)
                : this.helper.findPosX(parentButton, mainClassName) - (leftOffset || 0))
            : ((animDirect === 'Right')
                ? (this.helper.findPosX(parentButton, mainClassName) + parentButton.offsetWidth + 2)
                : (this.helper.findPosX(parentButton, mainClassName) - parentButton.offsetWidth - 2));
        if (left + innerContent.offsetWidth > browserWidth) {
            left = browserWidth - innerContent.offsetWidth - 15;
        }
        if (left < 0) {
            left = 10;
        }
        menu.left = left;
        if (animDirect === 'Down' &&
            this.helper.findPosY(parentButton) + parentButton.offsetHeight + innerContent.offsetHeight > browserHeight &&
            this.helper.findPosY(parentButton) - innerContent.offsetHeight > 0) {
            animDirect = 'Up';
        }
        menu.top = (isVertMenu)
            ? ((animDirect === 'Down')
                ? (this.helper.findPosY(parentButton, mainClassName) + parentButton.offsetHeight + 2)
                : (this.helper.findPosY(parentButton, mainClassName) - offsetHeight))
            : (this.helper.findPosY(parentButton, mainClassName) + parentButton.offsetHeight + innerContent.offsetHeight > browserHeight &&
                (browserHeight - innerContent.offsetHeight - 10) > 0)
                ? (browserHeight - innerContent.offsetHeight - 10)
                : this.helper.findPosY(parentButton, mainClassName);
        menu.width = innerContent.offsetWidth;
        menu.height = innerContent.offsetHeight;
        if (menu.top + innerContent.offsetHeight > browserHeight) {
            menu.top = (browserHeight - innerContent.offsetHeight - 10);
        }
        if (menu.top < 0) {
            menu.top = 10;
        }
        menu.state = animDirect === 'Down' ? 'initialDown' : 'initialUp';
        return menu;
    }
    get menus() {
        return Object.values(this._menus);
    }
    getVerticalMenu() {
        return this._menus[this.VERTICAL_MENU_NAME];
    }
    getMenu(name) {
        return this._menus[name];
    }
};
MenuService.ctorParameters = () => [
    { type: HelperService },
    { type: ModelService },
    { type: MouseService }
];
MenuService = __decorate([
    Injectable()
], MenuService);
export { MenuService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vc3RpbXVsc29mdC12aWV3ZXItYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9tZW51L21lbnUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBNEIsTUFBTSxlQUFlLENBQUM7QUFFckUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzNELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFekQsT0FBTyxFQUFFLE9BQU8sRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUUzQyxNQUFNLE9BQU8sSUFBSTtJQUNmLFlBQW1CLElBQVksRUFBUyxLQUFpQixFQUFTLE1BQWtCLEVBQVMsSUFBWSxFQUFTLEtBQWMsRUFDdkgsTUFBbUIsRUFBUyxHQUFZLEVBQVMsSUFBYSxFQUFTLFlBQXlCLEVBQVMsS0FBYyxFQUFTLE1BQWUsRUFDL0ksYUFBc0IsRUFBUyxNQUFpQixFQUFTLGFBQXNCLEVBQVMsTUFBMEIsRUFDbEgsYUFBc0IsRUFBUyxLQUFXLEVBQVMsU0FBa0I7UUFIM0QsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUFTLFVBQUssR0FBTCxLQUFLLENBQVk7UUFBUyxXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQVMsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUFTLFVBQUssR0FBTCxLQUFLLENBQVM7UUFDdkgsV0FBTSxHQUFOLE1BQU0sQ0FBYTtRQUFTLFFBQUcsR0FBSCxHQUFHLENBQVM7UUFBUyxTQUFJLEdBQUosSUFBSSxDQUFTO1FBQVMsaUJBQVksR0FBWixZQUFZLENBQWE7UUFBUyxVQUFLLEdBQUwsS0FBSyxDQUFTO1FBQVMsV0FBTSxHQUFOLE1BQU0sQ0FBUztRQUMvSSxrQkFBYSxHQUFiLGFBQWEsQ0FBUztRQUFTLFdBQU0sR0FBTixN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QUksQ0FBQyxHQUFHLEdBQUcsWUFBWSxDQUFDLFlBQVksR0FBRyxhQUFhLEVBQUU7WUFDeEQsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLGFBQWEsR0FBRyxZQUFZLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQzdEO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsRUFBRTtZQUNoQixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQztTQUNmO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxVQUFVLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUVqRSxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxJQUFJLEtBQUs7UUFDUCxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRCxlQUFlO1FBQ2IsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRCxPQUFPLENBQUMsSUFBWTtRQUNsQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0IsQ0FBQztDQUVGLENBQUE7O1lBeEo2QixhQUFhO1lBQWlCLFlBQVk7WUFBd0IsWUFBWTs7QUFSL0YsV0FBVztJQUR2QixVQUFVLEVBQUU7R0FDQSxXQUFXLENBZ0t2QjtTQWhLWSxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1lbnVJdGVtIH0gZnJvbSAnLi9tZW5pLWl0ZW0uY29tcG9uZW50JztcclxuaW1wb3J0IHsgSGVscGVyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2hlbHBlci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTW9kZWxTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvbW9kZWwuc2VydmljZSc7XHJcbmltcG9ydCB7IE1vdXNlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL21vdXNlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBWYXJpYWJsZSwgSXRlbSB9IGZyb20gJy4uL3NlcnZpY2VzL29iamVjdHMnO1xyXG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcblxyXG5leHBvcnQgY2xhc3MgTWVudSB7XHJcbiAgY29uc3RydWN0b3IocHVibGljIG5hbWU6IHN0cmluZywgcHVibGljIGl0ZW1zOiBNZW51SXRlbVtdLCBwdWJsaWMgcGFyZW50OiBFbGVtZW50UmVmLCBwdWJsaWMgdHlwZTogc3RyaW5nLCBwdWJsaWMgc3RhdGU/OiBzdHJpbmcsXHJcbiAgICBwdWJsaWMgbWVudUVsPzogRWxlbWVudFJlZiwgcHVibGljIHRvcD86IG51bWJlciwgcHVibGljIGxlZnQ/OiBudW1iZXIsIHB1YmxpYyBpbm5lckNvbnRlbnQ/OiBFbGVtZW50UmVmLCBwdWJsaWMgd2lkdGg/OiBudW1iZXIsIHB1YmxpYyBoZWlnaHQ/OiBudW1iZXIsXHJcbiAgICBwdWJsaWMgbWVudVN0eWxlTmFtZT86IHN0cmluZywgcHVibGljIHBhcmFtcz86IFZhcmlhYmxlLCBwdWJsaWMgdmVydGljYWxJdGVtcz86IEl0ZW1bXSwgcHVibGljIGFjdGlvbj86IEV2ZW50RW1pdHRlcjxhbnk+LFxyXG4gICAgcHVibGljIGl0ZW1TdHlsZU5hbWU/OiBzdHJpbmcsIHB1YmxpYyB2YWx1ZT86IGFueSwgcHVibGljIHNpemVTdHlsZT86IHN0cmluZykgeyB9XHJcbn1cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE1lbnVTZXJ2aWNlIHtcclxuICBwdWJsaWMgVkVSVElDQUxfTUVOVV9OQU1FID0gJ3ZlcnRpY2FsTWVudSc7XHJcblxyXG4gIHB1YmxpYyBtZW51TW91c2VVcCA9ICcnO1xyXG5cclxuICBwcml2YXRlIF9tZW51czoge30gPSB7fTtcclxuICBwcml2YXRlIHN1YmplY3QgPSBuZXcgU3ViamVjdDxNZW51PigpO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGhlbHBlcjogSGVscGVyU2VydmljZSwgcHJpdmF0ZSBtb2RlbDogTW9kZWxTZXJ2aWNlLCBwcml2YXRlIG1vdXNlU2VydmljZTogTW91c2VTZXJ2aWNlKSB7XHJcbiAgICB0aGlzLm1vdXNlU2VydmljZS5nZXREb2N1bWVudE1vdXNlVXAoKS5zdWJzY3JpYmUoKGV2ZW50KSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLm1lbnVNb3VzZVVwID09PSAnJykge1xyXG4gICAgICAgIHRoaXMuY2xvc2VBbGxNZW51cygpO1xyXG4gICAgICB9IGVsc2UgaWYgKHRoaXMubWVudU1vdXNlVXAgIT09ICdkYXRlUGlja2VyTWVudScgJiYgdGhpcy5tZW51TW91c2VVcCAhPT0gdGhpcy5WRVJUSUNBTF9NRU5VX05BTUUpIHtcclxuICAgICAgICBjb25zdCBkYXRlUGlja2VyID0gT2JqZWN0LnZhbHVlcyh0aGlzLl9tZW51cykuZmluZChtID0+IChtIGFzIE1lbnUpLnR5cGUgPT09ICdkYXRlUGlja2VyTWVudScpIGFzIE1lbnU7XHJcbiAgICAgICAgaWYgKGRhdGVQaWNrZXIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgZGF0ZVBpY2tlci5zdGF0ZSA9ICdpbml0aWFsRG93bic7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHRoaXMubWVudU1vdXNlVXAgPSAnJztcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldFZpc2liaWxpdHkoKTogT2JzZXJ2YWJsZTxNZW51PiB7XHJcbiAgICByZXR1cm4gdGhpcy5zdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFkZE1lbnUobWVudTogTWVudSk6IHZvaWQge1xyXG4gICAgdGhpcy5fbWVudXNbbWVudS5uYW1lXSA9IG1lbnU7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgY2xvc2VBbGxNZW51cygpIHtcclxuICAgIE9iamVjdC52YWx1ZXModGhpcy5fbWVudXMpLmZvckVhY2goKG06IE1lbnUpID0+IG0uc3RhdGUgPSBtLnR5cGUgPT09ICdidXR0b25NZW51JyAmJiB0aGlzLm1vZGVsLm9wdGlvbnMuaXNNb2JpbGVEZXZpY2UgPyAnaW5pdGlhbExlZnQnIDogJ2luaXRpYWxEb3duJyk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaXNNZW51VmlzaWJsZSgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBPYmplY3QudmFsdWVzKHRoaXMuX21lbnVzKS5maW5kKG0gPT4gKG0gYXMgTWVudSkuc3RhdGUgPT09ICdleHBhbmRlZCcpICE9IG51bGw7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2hvd01lbnUobWVudU5hbWU6IHN0cmluZykge1xyXG4gICAgY29uc3QgbWVudTogTWVudSA9IHRoaXMuX21lbnVzW21lbnVOYW1lXTtcclxuXHJcbiAgICBpZiAobWVudT8udHlwZSAhPT0gJ2RhdGVQaWNrZXJNZW51JyAmJiBtZW51Py50eXBlICE9PSB0aGlzLlZFUlRJQ0FMX01FTlVfTkFNRSkge1xyXG4gICAgICB0aGlzLmNsb3NlQWxsTWVudXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAobWVudSkge1xyXG4gICAgICBtZW51LnNpemVTdHlsZSA9ICdvcGFjaXR5OiAwOyc7XHJcbiAgICAgIGlmICh0aGlzLm1vZGVsLm9wdGlvbnMuaXNNb2JpbGVEZXZpY2UgJiYgbWVudS50eXBlID09PSAnYnV0dG9uTWVudScpIHtcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IGlubmVyQ29udGVudCA9IG1lbnUuaW5uZXJDb250ZW50Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgICBtZW51LmxlZnQgPSAwO1xyXG4gICAgICAgICAgbWVudS50b3AgPSAwO1xyXG4gICAgICAgICAgbWVudS53aWR0aCA9IGlubmVyQ29udGVudC5vZmZzZXRXaWR0aDtcclxuICAgICAgICAgIG1lbnUuaGVpZ2h0ID0gaW5uZXJDb250ZW50Lm9mZnNldEhlaWdodDtcclxuICAgICAgICAgIG1lbnUuc3RhdGUgPSAnaW5pdGlhbExlZnQnO1xyXG4gICAgICAgICAgbWVudS5zaXplU3R5bGUgPSBudWxsO1xyXG5cclxuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBtZW51LnN0YXRlID0gJ2V4cGFuZGVkJztcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgbWVudS5zaXplU3R5bGUgPSBudWxsO1xyXG4gICAgICAgICAgdGhpcy5zaG93TWVudUludGVybmFsKG1lbnUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuc3ViamVjdC5uZXh0KG1lbnUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzaG93TWVudUludGVybmFsKG1lbnU6IE1lbnUpIHtcclxuICAgIGNvbnN0IGlzVmVydE1lbnUgPSB0cnVlO1xyXG5cclxuICAgIGNvbnN0IHBhcmVudEJ1dHRvbiA9IG1lbnUucGFyZW50Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICBjb25zdCBpbm5lckNvbnRlbnQgPSBtZW51LmlubmVyQ29udGVudC5uYXRpdmVFbGVtZW50O1xyXG4gICAgY29uc3Qgb2Zmc2V0SGVpZ2h0ID0gbWVudS5tZW51RWwubmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHQ7XHJcbiAgICBjb25zdCBzdHlsZSA9IG1lbnUubWVudUVsLm5hdGl2ZUVsZW1lbnQuc3R5bGU7XHJcblxyXG4gICAgY29uc3QgY29vcmRzID0gdGhpcy5nZXRNZW51Q29vcmRpbmF0ZXMocGFyZW50QnV0dG9uLCBpbm5lckNvbnRlbnQsIG9mZnNldEhlaWdodCwgc3R5bGUsIGlzVmVydE1lbnUpO1xyXG5cclxuICAgIG1lbnUubGVmdCA9IGNvb3Jkcy5sZWZ0O1xyXG4gICAgbWVudS50b3AgPSBjb29yZHMudG9wO1xyXG4gICAgbWVudS53aWR0aCA9IG1lbnUud2lkdGggfHwgY29vcmRzLndpZHRoO1xyXG4gICAgbWVudS5oZWlnaHQgPSBjb29yZHMuaGVpZ2h0O1xyXG4gICAgbWVudS5zdGF0ZSA9IGNvb3Jkcy5zdGF0ZTtcclxuXHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgbWVudS5zdGF0ZSA9ICdleHBhbmRlZCc7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXRNZW51Q29vcmRpbmF0ZXMocGFyZW50QnV0dG9uOiBhbnksIGlubmVyQ29udGVudDogYW55LCBvZmZzZXRIZWlnaHQ6IG51bWJlciwgc3R5bGU6IGFueSwgaXNWZXJ0TWVudTogYm9vbGVhbik6IGFueSB7XHJcbiAgICBjb25zdCBtZW51OiBhbnkgPSB7fTtcclxuICAgIGNvbnN0IGJyb3dzZXJXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCB8fCBkb2N1bWVudC5ib2R5LmNsaWVudFdpZHRoO1xyXG4gICAgY29uc3QgYnJvd3NlckhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0IHx8IGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0O1xyXG4gICAgY29uc3QgcmlnaHRBbGlnbiA9IGZhbHNlO1xyXG4gICAgY29uc3QgbWFpbkNsYXNzTmFtZSA9ICdzdGlKc1ZpZXdlck1haW5QYW5lbCc7XHJcbiAgICBsZXQgYW5pbURpcmVjdCA9ICdEb3duJztcclxuICAgIGNvbnN0IGxlZnRPZmZzZXQgPSAwO1xyXG5cclxuICAgIGxldCBsZWZ0ID0gKGlzVmVydE1lbnUpXHJcbiAgICAgID8gKHRoaXMubW9kZWwub3B0aW9ucy5hcHBlYXJhbmNlLnJpZ2h0VG9MZWZ0IHx8IHJpZ2h0QWxpZ25cclxuICAgICAgICA/ICh0aGlzLmhlbHBlci5maW5kUG9zWChwYXJlbnRCdXR0b24sIG1haW5DbGFzc05hbWUpIC0gaW5uZXJDb250ZW50Lm9mZnNldFdpZHRoICsgcGFyZW50QnV0dG9uLm9mZnNldFdpZHRoKSAtIChsZWZ0T2Zmc2V0IHx8IDApXHJcbiAgICAgICAgOiB0aGlzLmhlbHBlci5maW5kUG9zWChwYXJlbnRCdXR0b24sIG1haW5DbGFzc05hbWUpIC0gKGxlZnRPZmZzZXQgfHwgMCkpXHJcbiAgICAgIDogKChhbmltRGlyZWN0ID09PSAnUmlnaHQnKVxyXG4gICAgICAgID8gKHRoaXMuaGVscGVyLmZpbmRQb3NYKHBhcmVudEJ1dHRvbiwgbWFpbkNsYXNzTmFtZSkgKyBwYXJlbnRCdXR0b24ub2Zmc2V0V2lkdGggKyAyKVxyXG4gICAgICAgIDogKHRoaXMuaGVscGVyLmZpbmRQb3NYKHBhcmVudEJ1dHRvbiwgbWFpbkNsYXNzTmFtZSkgLSBwYXJlbnRCdXR0b24ub2Zmc2V0V2lkdGggLSAyKSk7XHJcblxyXG4gICAgaWYgKGxlZnQgKyBpbm5lckNvbnRlbnQub2Zmc2V0V2lkdGggPiBicm93c2VyV2lkdGgpIHtcclxuICAgICAgbGVmdCA9IGJyb3dzZXJXaWR0aCAtIGlubmVyQ29udGVudC5vZmZzZXRXaWR0aCAtIDE1O1xyXG4gICAgfVxyXG4gICAgaWYgKGxlZnQgPCAwKSB7XHJcbiAgICAgIGxlZnQgPSAxMDtcclxuICAgIH1cclxuICAgIG1lbnUubGVmdCA9IGxlZnQ7XHJcblxyXG4gICAgaWYgKGFuaW1EaXJlY3QgPT09ICdEb3duJyAmJlxyXG4gICAgICB0aGlzLmhlbHBlci5maW5kUG9zWShwYXJlbnRCdXR0b24pICsgcGFyZW50QnV0dG9uLm9mZnNldEhlaWdodCArIGlubmVyQ29udGVudC5vZmZzZXRIZWlnaHQgPiBicm93c2VySGVpZ2h0ICYmXHJcbiAgICAgIHRoaXMuaGVscGVyLmZpbmRQb3NZKHBhcmVudEJ1dHRvbikgLSBpbm5lckNvbnRlbnQub2Zmc2V0SGVpZ2h0ID4gMCkge1xyXG4gICAgICBhbmltRGlyZWN0ID0gJ1VwJztcclxuICAgIH1cclxuXHJcbiAgICBtZW51LnRvcCA9IChpc1ZlcnRNZW51KVxyXG4gICAgICA/ICgoYW5pbURpcmVjdCA9PT0gJ0Rvd24nKVxyXG4gICAgICAgID8gKHRoaXMuaGVscGVyLmZpbmRQb3NZKHBhcmVudEJ1dHRvbiwgbWFpbkNsYXNzTmFtZSkgKyBwYXJlbnRCdXR0b24ub2Zmc2V0SGVpZ2h0ICsgMilcclxuICAgICAgICA6ICh0aGlzLmhlbHBlci5maW5kUG9zWShwYXJlbnRCdXR0b24sIG1haW5DbGFzc05hbWUpIC0gb2Zmc2V0SGVpZ2h0KSlcclxuICAgICAgOiAodGhpcy5oZWxwZXIuZmluZFBvc1kocGFyZW50QnV0dG9uLCBtYWluQ2xhc3NOYW1lKSArIHBhcmVudEJ1dHRvbi5vZmZzZXRIZWlnaHQgKyBpbm5lckNvbnRlbnQub2Zmc2V0SGVpZ2h0ID4gYnJvd3NlckhlaWdodCAmJlxyXG4gICAgICAgIChicm93c2VySGVpZ2h0IC0gaW5uZXJDb250ZW50Lm9mZnNldEhlaWdodCAtIDEwKSA+IDApXHJcbiAgICAgICAgPyAoYnJvd3NlckhlaWdodCAtIGlubmVyQ29udGVudC5vZmZzZXRIZWlnaHQgLSAxMClcclxuICAgICAgICA6IHRoaXMuaGVscGVyLmZpbmRQb3NZKHBhcmVudEJ1dHRvbiwgbWFpbkNsYXNzTmFtZSk7XHJcblxyXG4gICAgbWVudS53aWR0aCA9IGlubmVyQ29udGVudC5vZmZzZXRXaWR0aDtcclxuICAgIG1lbnUuaGVpZ2h0ID0gaW5uZXJDb250ZW50Lm9mZnNldEhlaWdodDtcclxuXHJcbiAgICBpZiAobWVudS50b3AgKyBpbm5lckNvbnRlbnQub2Zmc2V0SGVpZ2h0ID4gYnJvd3NlckhlaWdodCkge1xyXG4gICAgICBtZW51LnRvcCA9IChicm93c2VySGVpZ2h0IC0gaW5uZXJDb250ZW50Lm9mZnNldEhlaWdodCAtIDEwKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAobWVudS50b3AgPCAwKSB7XHJcbiAgICAgIG1lbnUudG9wID0gMTA7XHJcbiAgICB9XHJcblxyXG4gICAgbWVudS5zdGF0ZSA9IGFuaW1EaXJlY3QgPT09ICdEb3duJyA/ICdpbml0aWFsRG93bicgOiAnaW5pdGlhbFVwJztcclxuXHJcbiAgICByZXR1cm4gbWVudTtcclxuICB9XHJcblxyXG4gIGdldCBtZW51cygpOiBNZW51W10ge1xyXG4gICAgcmV0dXJuIE9iamVjdC52YWx1ZXModGhpcy5fbWVudXMpO1xyXG4gIH1cclxuXHJcbiAgZ2V0VmVydGljYWxNZW51KCk6IE1lbnUge1xyXG4gICAgcmV0dXJuIHRoaXMuX21lbnVzW3RoaXMuVkVSVElDQUxfTUVOVV9OQU1FXTtcclxuICB9XHJcblxyXG4gIGdldE1lbnUobmFtZTogc3RyaW5nKTogTWVudSB7XHJcbiAgICByZXR1cm4gdGhpcy5fbWVudXNbbmFtZV07XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=