import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError, timeout } from 'rxjs/operators';
import { ModelService } from './model.service';
import { HelperService } from './helper.service';
var StiHttpClientService = /** @class */ (function () {
    function StiHttpClientService(httpClient, model, helper) {
        this.httpClient = httpClient;
        this.model = model;
        this.helper = helper;
    }
    StiHttpClientService.prototype.post = function (url, data, responseType) {
        var _this = this;
        if (responseType === void 0) { responseType = 'json'; }
        var _a, _b, _c, _d;
        var model = this.model;
        model.showProgress = true;
        var reqTimeout = ((_b = (_a = this.model.options) === null || _a === void 0 ? void 0 : _a.server) === null || _b === void 0 ? void 0 : _b.requestTimeout) > 0 ? ((_d = (_c = this.model.options) === null || _c === void 0 ? void 0 : _c.server) === null || _d === void 0 ? void 0 : _d.requestTimeout) * 1000 : 1000 * 1000;
        if (responseType === 'json') {
            return this.httpClient.post(url, this.getFormData(data)).pipe(
            // retry(3),
            timeout(reqTimeout), catchError(function (error) {
                model.httpError = error;
                model.showProgress = false;
                _this.model.controls.navigatePanel.enabled = true;
                _this.model.controls.toolbar.enabled = true;
                return throwError('Something bad happened; please try again later.');
            }));
        }
        else {
            return this.httpClient.post(url, this.getFormData(data), { responseType: 'text' }).pipe(
            // retry(3),
            timeout(reqTimeout), catchError(function (error) {
                model.httpError = error;
                model.showProgress = false;
                _this.model.controls.navigatePanel.enabled = true;
                _this.model.controls.toolbar.enabled = true;
                return throwError('Something bad happened; please try again later.');
            }));
        }
    };
    StiHttpClientService.prototype.getFormData = function (data) {
        var formData = new FormData();
        Object.keys(data).forEach(function (key) { return formData.append(key, data[key]); });
        return formData;
    };
    StiHttpClientService.prototype.postForm = function (url, data, doc, postOnlyData) {
        var _this = this;
        if (postOnlyData === void 0) { postOnlyData = false; }
        if (!doc) {
            doc = document;
        }
        var form = doc.createElement('FORM');
        form.setAttribute('method', 'POST');
        form.setAttribute('action', url);
        var params = postOnlyData ? data : this.model.createPostParameters(data, true);
        Object.keys(params).forEach(function (key) {
            var paramsField = doc.createElement('INPUT');
            paramsField.setAttribute('type', 'hidden');
            paramsField.setAttribute('name', key);
            paramsField.setAttribute('value', params[key]);
            form.appendChild(paramsField);
        });
        if (this.model.options.jsDesigner) {
            this.model.options.jsDesigner.options.ignoreBeforeUnload = true;
        }
        doc.body.appendChild(form);
        form.submit();
        doc.body.removeChild(form);
        setTimeout(function () {
            if (_this.model.options.jsDesigner) {
                _this.model.options.jsDesigner.options.ignoreBeforeUnload = false;
            }
        }, 500);
    };
    StiHttpClientService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: ModelService },
        { type: HelperService }
    ]; };
    StiHttpClientService = __decorate([
        Injectable()
    ], StiHttpClientService);
    return StiHttpClientService;
}());
export { StiHttpClientService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1jbGllbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3N0aW11bHNvZnQtdmlld2VyLWFuZ3VsYXIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvaHR0cC1jbGllbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFHakQ7SUFFRSw4QkFBb0IsVUFBc0IsRUFBUyxLQUFtQixFQUFVLE1BQXFCO1FBQWpGLGVBQVUsR0FBVixVQUFVLENBQVk7UUFBUyxVQUFLLEdBQUwsS0FBSyxDQUFjO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFJLENBQUM7SUFFbkcsbUNBQUksR0FBWCxVQUFZLEdBQVcsRUFBRSxJQUFTLEVBQUUsWUFBNkI7UUFBakUsaUJBNEJDO1FBNUJtQyw2QkFBQSxFQUFBLHFCQUE2Qjs7UUFDL0QsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN6QixLQUFLLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztRQUMxQixJQUFNLFVBQVUsR0FBRyxhQUFBLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTywwQ0FBRSxNQUFNLDBDQUFFLGNBQWMsSUFBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQUEsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLDBDQUFFLE1BQU0sMENBQUUsY0FBYyxJQUFHLElBQUksQ0FBQyxDQUFDLENBQUMs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USxDQUFDLENBQUM7WUFDM0MsV0FBVyxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDdEMsV0FBVyxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDL0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFO1lBQ2pDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO1NBQ2pFO1FBRUQsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2QsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFM0IsVUFBVSxDQUFDO1lBQ1QsSUFBSSxLQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUU7Z0JBQ2pDLEtBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO2FBQ2xFO1FBQ0gsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ1YsQ0FBQzs7Z0JBbkUrQixVQUFVO2dCQUFnQixZQUFZO2dCQUFrQixhQUFhOztJQUYxRixvQkFBb0I7UUFEaEMsVUFBVSxFQUFFO09BQ0Esb0JBQW9CLENBdUVoQztJQUFELDJCQUFDO0NBQUEsQUF2RUQsSUF1RUM7U0F2RVksb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGNhdGNoRXJyb3IsIHRpbWVvdXQgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE1vZGVsU2VydmljZSB9IGZyb20gJy4vbW9kZWwuc2VydmljZSc7XHJcbmltcG9ydCB7IEhlbHBlclNlcnZpY2UgfSBmcm9tICcuL2hlbHBlci5zZXJ2aWNlJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFN0aUh0dHBDbGllbnRTZXJ2aWNlIHtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LCBwdWJsaWMgbW9kZWw6IE1vZGVsU2VydmljZSwgcHJpdmF0ZSBoZWxwZXI6IEhlbHBlclNlcnZpY2UpIHsgfVxyXG5cclxuICBwdWJsaWMgcG9zdCh1cmw6IHN0cmluZywgZGF0YTogYW55LCByZXNwb25zZVR5cGU6IHN0cmluZyA9ICdqc29uJyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBtb2RlbCA9IHRoaXMubW9kZWw7XHJcbiAgICBtb2RlbC5zaG93UHJvZ3Jlc3MgPSB0cnVlO1xyXG4gICAgY29uc3QgcmVxVGltZW91dCA9IHRoaXMubW9kZWwub3B0aW9ucz8uc2VydmVyPy5yZXF1ZXN0VGltZW91dCA+IDAgPyB0aGlzLm1vZGVsLm9wdGlvbnM/LnNlcnZlcj8ucmVxdWVzdFRpbWVvdXQgKiAxMDAwIDogMTAwMCAqIDEwMDA7XHJcbiAgICBpZiAocmVzcG9uc2VUeXBlID09PSAnanNvbicpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudC5wb3N0KHVybCwgdGhpcy5nZXRGb3JtRGF0YShkYXRhKSkucGlwZShcclxuICAgICAgICAvLyByZXRyeSgzKSxcclxuICAgICAgICB0aW1lb3V0KHJlcVRpbWVvdXQpLFxyXG5cclxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICBtb2RlbC5odHRwRXJyb3IgPSBlcnJvcjtcclxuICAgICAgICAgIG1vZGVsLnNob3dQcm9ncmVzcyA9IGZhbHNlO1xyXG4gICAgICAgICAgdGhpcy5tb2RlbC5jb250cm9scy5uYXZpZ2F0ZVBhbmVsLmVuYWJsZWQgPSB0cnVlO1xyXG4gICAgICAgICAgdGhpcy5tb2RlbC5jb250cm9scy50b29sYmFyLmVuYWJsZWQgPSB0cnVlO1xyXG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ1NvbWV0aGluZyBiYWQgaGFwcGVuZWQ7IHBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJyk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudC5wb3N0KHVybCwgdGhpcy5nZXRGb3JtRGF0YShkYXRhKSwgeyByZXNwb25zZVR5cGU6ICd0ZXh0JyB9KS5waXBlKFxyXG4gICAgICAgIC8vIHJldHJ5KDMpLFxyXG4gICAgICAgIHRpbWVvdXQocmVxVGltZW91dCksXHJcbiAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgbW9kZWwuaHR0cEVycm9yID0gZXJyb3I7XHJcbiAgICAgICAgICBtb2RlbC5zaG93UHJvZ3Jlc3MgPSBmYWxzZTtcclxuICAgICAgICAgIHRoaXMubW9kZWwuY29udHJvbHMubmF2aWdhdGVQYW5lbC5lbmFibGVkID0gdHJ1ZTtcclxuICAgICAgICAgIHRoaXMubW9kZWwuY29udHJvbHMudG9vbGJhci5lbmFibGVkID0gdHJ1ZTtcclxuICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdTb21ldGhpbmcgYmFkIGhhcHBlbmVkOyBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0Rm9ybURhdGEoZGF0YTogYW55KTogRm9ybURhdGEge1xyXG4gICAgY29uc3QgZm9ybURhdGE6IEZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcbiAgICBPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGtleSA9PiBmb3JtRGF0YS5hcHBlbmQoa2V5LCBkYXRhW2tleV0pKTtcclxuICAgIHJldHVybiBmb3JtRGF0YTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBwb3N0Rm9ybSh1cmw6IHN0cmluZywgZGF0YTogYW55LCBkb2M6IGFueSwgcG9zdE9ubHlEYXRhOiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgIGlmICghZG9jKSB7IGRvYyA9IGRvY3VtZW50OyB9XHJcbiAgICBjb25zdCBmb3JtID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ0ZPUk0nKTtcclxuICAgIGZvcm0uc2V0QXR0cmlidXRlKCdtZXRob2QnLCAnUE9TVCcpO1xyXG4gICAgZm9ybS5zZXRBdHRyaWJ1dGUoJ2FjdGlvbicsIHVybCk7XHJcblxyXG4gICAgY29uc3QgcGFyYW1zID0gcG9zdE9ubHlEYXRhID8gZGF0YSA6IHRoaXMubW9kZWwuY3JlYXRlUG9zdFBhcmFtZXRlcnMoZGF0YSwgdHJ1ZSk7XHJcblxyXG4gICAgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgIGNvbnN0IHBhcmFtc0ZpZWxkID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ0lOUFVUJyk7XHJcbiAgICAgIHBhcmFtc0ZpZWxkLnNldEF0dHJpYnV0ZSgndHlwZScsICdoaWRkZW4nKTtcclxuICAgICAgcGFyYW1zRmllbGQuc2V0QXR0cmlidXRlKCduYW1lJywga2V5KTtcclxuICAgICAgcGFyYW1zRmllbGQuc2V0QXR0cmlidXRlKCd2YWx1ZScsIHBhcmFtc1trZXldKTtcclxuICAgICAgZm9ybS5hcHBlbmRDaGlsZChwYXJhbXNGaWVsZCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAodGhpcy5tb2RlbC5vcHRpb25zLmpzRGVzaWduZXIpIHtcclxuICAgICAgdGhpcy5tb2RlbC5vcHRpb25zLmpzRGVzaWduZXIub3B0aW9ucy5pZ25vcmVCZWZvcmVVbmxvYWQgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKGZvcm0pO1xyXG4gICAgZm9ybS5zdWJtaXQoKTtcclxuICAgIGRvYy5ib2R5LnJlbW92ZUNoaWxkKGZvcm0pO1xyXG5cclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5tb2RlbC5vcHRpb25zLmpzRGVzaWduZXIpIHtcclxuICAgICAgICB0aGlzLm1vZGVsLm9wdGlvbnMuanNEZXNpZ25lci5vcHRpb25zLmlnbm9yZUJlZm9yZVVubG9hZCA9IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9LCA1MDApO1xyXG4gIH1cclxuXHJcbn1cclxuIl19