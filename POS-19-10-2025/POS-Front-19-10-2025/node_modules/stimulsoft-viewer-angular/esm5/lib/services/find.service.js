import { __decorate, __values } from "tslib";
import { Injectable } from '@angular/core';
import { ModelService } from './model.service';
import { HelperService } from './helper.service';
import { AnimationService } from './animation.service';
var FindService = /** @class */ (function () {
    function FindService(model, helper, animationService) {
        var _this = this;
        this.model = model;
        this.helper = helper;
        this.animationService = animationService;
        this.symbols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890';
        this.findLabels = [];
        this.text = '';
        this.lastFindText = '';
        this.matchCase = false;
        this.matchWholeWord = false;
        this.findMode = false;
        model.controls.findPanel.getVisibility().subscribe(function (value) {
            if (!value) {
                _this.hideFindLabels();
                _this.lastFindText = '';
            }
        });
    }
    FindService.prototype.hideFindLabels = function () {
        this.findLabels.forEach(function (findLabel) {
            var parentElement = findLabel.parentElement;
            parentElement.removeChild(findLabel);
            if (parentElement.oldPositionStyle) {
                parentElement.style.position = parentElement.oldPositionStyle;
            }
        });
        this.findLabels = [];
        this.findMode = false;
        this.lastFindText = '';
    };
    FindService.prototype.selectFindLabel = function (direction) {
        if (this.findLabels.length === 0) {
            return;
        }
        var selectedIndex = 0;
        var labels = this.findLabels;
        for (var i = 0; i < labels.length; i++) {
            if (labels[i].isSelected) {
                labels[i].setSelected(false);
                selectedIndex = i;
                break;
            }
        }
        if (direction === 'Next') {
            selectedIndex++;
            if (selectedIndex > labels.length - 1) {
                selectedIndex = 0;
            }
        }
        else {
            selectedIndex--;
            if (selectedIndex < 0) {
                selectedIndex = labels.length - 1;
            }
        }
        labels[selectedIndex].setSelected(true);
        this.goToFindedElement(labels[selectedIndex]);
    };
    FindService.prototype.showFindLabels = function () {
        var _this = this;
        this.hideFindLabels();
        this.findMode = true;
        this.lastFindText = this.text;
        var text = this.matchCase ? this.text : this.text.toLowerCase();
        this.model.pages.forEach(function (page) {
            var e_1, _a;
            var pageElements = page.page.getElementsByTagName('*');
            try {
                for (var pageElements_1 = __values(pageElements), pageElements_1_1 = pageElements_1.next(); !pageElements_1_1.done; pageElements_1_1 = pageElements_1.next()) {
                    var pageElement = pageElements_1_1.value;
                    var innerText = pageElement.innerHTML;
                    if (innerText && pageElement.childNodes.length === 1 && pageElement.childNodes[0].nodeName === '#text') {
                        if (!_this.matchCase) {
                            innerText = innerText.toLowerCase();
                        }
                        if (innerText.indexOf(text) >= 0) {
                            if (_this.matchWholeWord && !_this.isWholeWord(innerText, text)) {
                                continue;
                            }
                            var label = document.createElement('div');
                            label.ownerElement = pageElement;
                            label.className = 'stiJsViewerFindLabel';
                            label.style.width = (pageElement.offsetWidth - 4) + 'px';
                            var labelHeight = pageElement.offsetHeight - 4;
                            label.style.height = labelHeight + 'px';
                            label.style.top = '0px';
                            label.style.left = '0px';
                            label.ownerElement.oldPositionStyle = label.ownerElement.style.position;
                            if (label.ownerElement.style.position !== 'absolute' && label.ownerElement.style.position !== 'fixed') {
                                label.ownerElement.style.position = 'relative';
                            }
                            pageElement.insertBefore(label, pageElement.childNodes[0]);
                            label.setSelected = function (state) {
                                this.isSelected = state;
                                this.style.border = '2px solid ' + (state ? 'red' : '#8a8a8a');
                            };
                            if (_this.findLabels.length === 0) {
                                label.setSelected(true);
                            }
                            _this.findLabels.push(label);
                        }
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (pageElements_1_1 && !pageElements_1_1.done && (_a = pageElements_1.return)) _a.call(pageElements_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        });
        if (this.findLabels.length > 0) {
            this.goToFindedElement(this.findLabels[0]);
        }
    };
    FindService.prototype.goToFindedElement = function (findLabel) {
        if (findLabel && findLabel.ownerElement) {
            var targetTop = this.helper.findPosY(findLabel.ownerElement, this.model.options.appearance.scrollbarsMode ? 'stiJsViewerReportPanel' : null, true) - findLabel.ownerElement.offsetHeight - 50;
            var d = new Date();
            var endTime = d.getTime() + this.model.options.scrollDuration;
            this.animationService.showAnimationForScroll(this.model.controls.reportPanel.el.nativeElement, targetTop, endTime, function () { });
        }
    };
    FindService.prototype.isWholeWord = function (str, word) {
        var index = str.indexOf(word);
        var preSymbol = str.substring(index - 1, index);
        var nextSymbol = str.substring(index + word.length, index + word.length + 1);
        return ((preSymbol === '' || this.symbols.indexOf(preSymbol) === -1) && (nextSymbol === '' || this.symbols.indexOf(nextSymbol) === -1));
    };
    FindService.ctorParameters = function () { return [
        { type: ModelService },
        { type: HelperService },
        { type: AnimationService }
    ]; };
    FindService = __decorate([
        Injectable()
    ], FindService);
    return FindService;
}());
export { FindService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmluZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vc3RpbXVsc29mdC12aWV3ZXItYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9maW5kLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd2RDtJQVdFLHFCQUFvQixLQUFtQixFQUFVLE1BQXFCLEVBQVUsZ0JBQWtDO1FBQWxILGlCQU9DO1FBUG1CLFVBQUssR0FBTCxLQUFLLENBQWM7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQVUscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQVQxRyxZQUFPLEdBQUcsZ0VBQWdFLENBQUM7UUFDM0UsZUFBVSxHQUFVLEVBQUUsQ0FBQztRQUV4QixTQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ1YsaUJBQVksR0FBRyxFQUFFLENBQUM7UUFDbEIsY0FBUyxHQUFHLEtBQUssQ0FBQztRQUNsQixtQkFBYyxHQUFHLEtBQUssQ0FBQztRQUN2QixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBR3RCLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFBRSxDQUFDLFNBQVMsQ0FBQyxVQUFDLEtBQUs7WUFDdkQsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDVixLQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3RCLEtBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO2FBQ3hCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sb0NBQWMsR0FBckI7UUFDRSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FB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cmUnO1xyXG5pbXBvcnQgeyBNb2RlbFNlcnZpY2UgfSBmcm9tICcuL21vZGVsLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBIZWxwZXJTZXJ2aWNlIH0gZnJvbSAnLi9oZWxwZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IEFuaW1hdGlvblNlcnZpY2UgfSBmcm9tICcuL2FuaW1hdGlvbi5zZXJ2aWNlJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEZpbmRTZXJ2aWNlIHtcclxuXHJcbiAgcHJpdmF0ZSBzeW1ib2xzID0gJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXoxMjM0NTY3ODkwJztcclxuICBwcml2YXRlIGZpbmRMYWJlbHM6IGFueVtdID0gW107XHJcblxyXG4gIHB1YmxpYyB0ZXh0ID0gJyc7XHJcbiAgcHVibGljIGxhc3RGaW5kVGV4dCA9ICcnO1xyXG4gIHB1YmxpYyBtYXRjaENhc2UgPSBmYWxzZTtcclxuICBwdWJsaWMgbWF0Y2hXaG9sZVdvcmQgPSBmYWxzZTtcclxuICBwdWJsaWMgZmluZE1vZGUgPSBmYWxzZTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBtb2RlbDogTW9kZWxTZXJ2aWNlLCBwcml2YXRlIGhlbHBlcjogSGVscGVyU2VydmljZSwgcHJpdmF0ZSBhbmltYXRpb25TZXJ2aWNlOiBBbmltYXRpb25TZXJ2aWNlKSB7XHJcbiAgICBtb2RlbC5jb250cm9scy5maW5kUGFuZWwuZ2V0VmlzaWJpbGl0eSgpLnN1YnNjcmliZSgodmFsdWUpID0+IHtcclxuICAgICAgaWYgKCF2YWx1ZSkge1xyXG4gICAgICAgIHRoaXMuaGlkZUZpbmRMYWJlbHMoKTtcclxuICAgICAgICB0aGlzLmxhc3RGaW5kVGV4dCA9ICcnO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBoaWRlRmluZExhYmVscygpIHtcclxuICAgIHRoaXMuZmluZExhYmVscy5mb3JFYWNoKChmaW5kTGFiZWwpID0+IHtcclxuICAgICAgY29uc3QgcGFyZW50RWxlbWVudCA9IGZpbmRMYWJlbC5wYXJlbnRFbGVtZW50O1xyXG4gICAgICBwYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGZpbmRMYWJlbCk7XHJcbiAgICAgIGlmIChwYXJlbnRFbGVtZW50Lm9sZFBvc2l0aW9uU3R5bGUpIHtcclxuICAgICAgICBwYXJlbnRFbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gcGFyZW50RWxlbWVudC5vbGRQb3NpdGlvblN0eWxlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLmZpbmRMYWJlbHMgPSBbXTtcclxuICAgIHRoaXMuZmluZE1vZGUgPSBmYWxzZTtcclxuICAgIHRoaXMubGFzdEZpbmRUZXh0ID0gJyc7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2VsZWN0RmluZExhYmVsKGRpcmVjdGlvbjogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpcy5maW5kTGFiZWxzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQgc2VsZWN0ZWRJbmRleCA9IDA7XHJcbiAgICBjb25zdCBsYWJlbHMgPSB0aGlzLmZpbmRMYWJlbHM7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxhYmVscy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBpZiAobGFiZWxzW2ldLmlzU2VsZWN0ZWQpIHtcclxuICAgICAgICBsYWJlbHNbaV0uc2V0U2VsZWN0ZWQoZmFsc2UpO1xyXG4gICAgICAgIHNlbGVjdGVkSW5kZXggPSBpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoZGlyZWN0aW9uID09PSAnTmV4dCcpIHtcclxuICAgICAgc2VsZWN0ZWRJbmRleCsrO1xyXG4gICAgICBpZiAoc2VsZWN0ZWRJbmRleCA+IGxhYmVscy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgc2VsZWN0ZWRJbmRleCA9IDA7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHNlbGVjdGVkSW5kZXgtLTtcclxuICAgICAgaWYgKHNlbGVjdGVkSW5kZXggPCAwKSB7XHJcbiAgICAgICAgc2VsZWN0ZWRJbmRleCA9IGxhYmVscy5sZW5ndGggLSAxO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBsYWJlbHNbc2VsZWN0ZWRJbmRleF0uc2V0U2VsZWN0ZWQodHJ1ZSk7XHJcbiAgICB0aGlzLmdvVG9GaW5kZWRFbGVtZW50KGxhYmVsc1tzZWxlY3RlZEluZGV4XSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2hvd0ZpbmRMYWJlbHMoKSB7XHJcbiAgICB0aGlzLmhpZGVGaW5kTGFiZWxzKCk7XHJcbiAgICB0aGlzLmZpbmRNb2RlID0gdHJ1ZTtcclxuICAgIHRoaXMubGFzdEZpbmRUZXh0ID0gdGhpcy50ZXh0O1xyXG4gICAgY29uc3QgdGV4dCA9IHRoaXMubWF0Y2hDYXNlID8gdGhpcy50ZXh0IDogdGhpcy50ZXh0LnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgdGhpcy5tb2RlbC5wYWdlcy5mb3JFYWNoKHBhZ2UgPT4ge1xyXG4gICAgICBjb25zdCBwYWdlRWxlbWVudHMgPSBwYWdlLnBhZ2UuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTtcclxuICAgICAgZm9yIChjb25zdCBwYWdlRWxlbWVudCBvZiBwYWdlRWxlbWVudHMpIHtcclxuICAgICAgICBsZXQgaW5uZXJUZXh0ID0gcGFnZUVsZW1lbnQuaW5uZXJIVE1MO1xyXG4gICAgICAgIGlmIChpbm5lclRleHQgJiYgcGFnZUVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgJiYgcGFnZUVsZW1lbnQuY2hpbGROb2Rlc1swXS5ub2RlTmFtZSA9PT0gJyN0ZXh0Jykge1xyXG4gICAgICAgICAgaWYgKCF0aGlzLm1hdGNoQ2FzZSkge1xyXG4gICAgICAgICAgICBpbm5lclRleHQgPSBpbm5lclRleHQudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmIChpbm5lclRleHQuaW5kZXhPZih0ZXh0KSA+PSAwKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm1hdGNoV2hvbGVXb3JkICYmICF0aGlzLmlzV2hvbGVXb3JkKGlubmVyVGV4dCwgdGV4dCkpIHtcclxuICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBsYWJlbDogYW55ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgIGxhYmVsLm93bmVyRWxlbWVudCA9IHBhZ2VFbGVtZW50O1xyXG4gICAgICAgICAgICBsYWJlbC5jbGFzc05hbWUgPSAnc3RpSnNWaWV3ZXJGaW5kTGFiZWwnO1xyXG4gICAgICAgICAgICBsYWJlbC5zdHlsZS53aWR0aCA9IChwYWdlRWxlbWVudC5vZmZzZXRXaWR0aCAtIDQpICsgJ3B4JztcclxuICAgICAgICAgICAgY29uc3QgbGFiZWxIZWlnaHQgPSBwYWdlRWxlbWVudC5vZmZzZXRIZWlnaHQgLSA0O1xyXG4gICAgICAgICAgICBsYWJlbC5zdHlsZS5oZWlnaHQgPSBsYWJlbEhlaWdodCArICdweCc7XHJcbiAgICAgICAgICAgIGxhYmVsLnN0eWxlLnRvcCA9ICcwcHgnO1xyXG4gICAgICAgICAgICBsYWJlbC5zdHlsZS5sZWZ0ID0gJzBweCc7XHJcbiAgICAgICAgICAgIGxhYmVsLm93bmVyRWxlbWVudC5vbGRQb3NpdGlvblN0eWxlID0gbGFiZWwub3duZXJFbGVtZW50LnN0eWxlLnBvc2l0aW9uO1xyXG4gICAgICAgICAgICBpZiAobGFiZWwub3duZXJFbGVtZW50LnN0eWxlLnBvc2l0aW9uICE9PSAnYWJzb2x1dGUnICYmIGxhYmVsLm93bmVyRWxlbWVudC5zdHlsZS5wb3NpdGlvbiAhPT0gJ2ZpeGVkJykge1xyXG4gICAgICAgICAgICAgIGxhYmVsLm93bmVyRWxlbWVudC5zdHlsZS5wb3NpdGlvbiA9ICdyZWxhdGl2ZSc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcGFnZUVsZW1lbnQuaW5zZXJ0QmVmb3JlKGxhYmVsLCBwYWdlRWxlbWVudC5jaGlsZE5vZGVzWzBdKTtcclxuXHJcbiAgICAgICAgICAgIGxhYmVsLnNldFNlbGVjdGVkID0gZnVuY3Rpb24gKHN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5pc1NlbGVjdGVkID0gc3RhdGU7XHJcbiAgICAgICAgICAgICAgdGhpcy5zdHlsZS5ib3JkZXIgPSAnMnB4IHNvbGlkICcgKyAoc3RhdGUgPyAncmVkJyA6ICcjOGE4YThhJyk7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5maW5kTGFiZWxzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgIGxhYmVsLnNldFNlbGVjdGVkKHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuZmluZExhYmVscy5wdXNoKGxhYmVsKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGlmICh0aGlzLmZpbmRMYWJlbHMubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aGlzLmdvVG9GaW5kZWRFbGVtZW50KHRoaXMuZmluZExhYmVsc1swXSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnb1RvRmluZGVkRWxlbWVudChmaW5kTGFiZWw6IGFueSkge1xyXG4gICAgaWYgKGZpbmRMYWJlbCAmJiBmaW5kTGFiZWwub3duZXJFbGVtZW50KSB7XHJcbiAgICAgIGNvbnN0IHRhcmdldFRvcCA9IHRoaXMuaGVscGVyLmZpbmRQb3NZKGZpbmRMYWJlbC5vd25lckVsZW1lbnQsIHRoaXMubW9kZWwub3B0aW9ucy5hcHBlYXJhbmNlLnNjcm9sbGJhcnNNb2RlID8gJ3N0aUpzVmlld2VyUmVwb3J0UGFuZWwnIDogbnVsbCwgdHJ1ZSkgLSBmaW5kTGFiZWwub3duZXJFbGVtZW50Lm9mZnNldEhlaWdodCAtIDUwO1xyXG4gICAgICBjb25zdCBkID0gbmV3IERhdGUoKTtcclxuICAgICAgY29uc3QgZW5kVGltZSA9IGQuZ2V0VGltZSgpICsgdGhpcy5tb2RlbC5vcHRpb25zLnNjcm9sbER1cmF0aW9uO1xyXG4gICAgICB0aGlzLmFuaW1hdGlvblNlcnZpY2Uuc2hvd0FuaW1hdGlvbkZvclNjcm9sbCh0aGlzLm1vZGVsLmNvbnRyb2xzLnJlcG9ydFBhbmVsLmVsLm5hdGl2ZUVsZW1lbnQsIHRhcmdldFRvcCwgZW5kVGltZSwgKCkgPT4geyB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGlzV2hvbGVXb3JkKHN0cjogc3RyaW5nLCB3b3JkOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGluZGV4ID0gc3RyLmluZGV4T2Yod29yZCk7XHJcbiAgICBjb25zdCBwcmVTeW1ib2wgPSBzdHIuc3Vic3RyaW5nKGluZGV4IC0gMSwgaW5kZXgpO1xyXG4gICAgY29uc3QgbmV4dFN5bWJvbCA9IHN0ci5zdWJzdHJpbmcoaW5kZXggKyB3b3JkLmxlbmd0aCwgaW5kZXggKyB3b3JkLmxlbmd0aCArIDEpO1xyXG5cclxuICAgIHJldHVybiAoKHByZVN5bWJvbCA9PT0gJycgfHwgdGhpcy5zeW1ib2xzLmluZGV4T2YocHJlU3ltYm9sKSA9PT0gLTEpICYmIChuZXh0U3ltYm9sID09PSAnJyB8fCB0aGlzLnN5bWJvbHMuaW5kZXhPZihuZXh0U3ltYm9sKSA9PT0gLTEpKTtcclxuICB9XHJcbn1cclxuIl19