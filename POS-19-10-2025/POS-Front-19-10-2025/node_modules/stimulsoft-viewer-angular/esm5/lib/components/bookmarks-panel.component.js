import { __decorate } from "tslib";
import { Component, ViewChild } from '@angular/core';
import { ModelService } from '../services/model.service';
import { HelperService } from '../services/helper.service';
import { ControllerService } from '../services/controller.service';
import { trigger, state, transition, animate, style, keyframes } from '@angular/animations';
var BookmarksPanelComponent = /** @class */ (function () {
    function BookmarksPanelComponent(model, helper, controller) {
        var _this = this;
        this.model = model;
        this.helper = helper;
        this.controller = controller;
        controller.getMessage().subscribe(function (message) {
            if (message.action === 'GetReport' || message.action === 'OpenReport') {
                setTimeout(function () {
                    if (_this.model.reportParams.bookmarksContent != null) {
                        _this.create();
                    }
                    _this.model.controls.bookmarksPanel.visible = _this.model.reportParams.bookmarksContent !== null && !_this.model.options.isMobileDevice;
                });
            }
            else {
                // Go to the bookmark, if it present
                setTimeout(function () {
                    if (_this.model.options.bookmarkAnchor != null) {
                        _this.helper.scrollToAnchor(_this.model.options.bookmarkAnchor, _this.model.options.componentGuid);
                        _this.model.options.bookmarkAnchor = null;
                        _this.model.options.componentGuid = null;
                    }
                });
            }
        });
        this.model.controls.bookmarksPanel.getVisibility().subscribe(function (value) {
            if (!value) {
                _this.helper.removeBookmarksLabel();
                _this.clearSelected();
            }
        });
    }
    BookmarksPanelComponent.prototype.ngAfterViewInit = function () {
        this.model.controls.bookmarksPanel.el = this.element;
    };
    BookmarksPanelComponent.prototype.ngOnInit = function () { };
    BookmarksPanelComponent.prototype.getImg1 = function (node, i) {
        var _a;
        if (((_a = node.nodes) === null || _a === void 0 ? void 0 : _a.length) === 0) {
            return i !== this.model.nodes.length - 1 ? this.model.imagesForBookmark['join'] : this.model.imagesForBookmark['joinBottom'];
        }
        return node.open ? (i === this.model.nodes.length - 1 ? this.model.imagesForBookmark['minusBottom'] : this.model.imagesForBookmark['minus']) :
            (i === this.model.nodes.length - 1 ? this.model.imagesForBookmark['plusBottom'] : this.model.imagesForBookmark['plus']);
    };
    BookmarksPanelComponent.prototype.postAction = function (node) {
        this.clearSelected();
        this.controller.postBookmarkNodeAction(node);
    };
    BookmarksPanelComponent.prototype.clearSelected = function () {
        var _a;
        (_a = this.model.nodes) === null || _a === void 0 ? void 0 : _a.forEach(function (n) {
            n.selected = false;
            n.nodes.forEach(function (element) { return element.selected = false; });
        });
    };
    BookmarksPanelComponent.prototype.create = function () {
        var bookmarks = this.model.reportParams.bookmarksContent.split('bookmarks.add(');
        var root = bookmarks[1].replace('0,-1,\'', '');
        this.rootName = root.substr(0, root.indexOf('\''));
        var nodes = [];
        this.parseNodes(bookmarks.splice(2), 0, nodes);
        this.model.nodes = nodes;
    };
    BookmarksPanelComponent.prototype.parseNodes = function (bookmarks, index, nodes) {
        var _this = this;
        var folder;
        bookmarks.forEach(function (bookmark) {
            var str = bookmark.substr(bookmark.indexOf(',') + 1);
            var nodeType = parseInt(str.substr(0, str.indexOf(',')), 10);
            var node = _this.parseNode(str);
            if (nodeType === 0) {
                nodes.push(node);
                folder = node;
            }
            else {
                folder.nodes.push(node);
            }
        });
    };
    BookmarksPanelComponent.prototype.parseNode = function (str) {
        str = str.substr(str.indexOf(',') + 2);
        var name = this.unescape(str.substr(0, str.indexOf('\',')));
        str = str.substr(str.indexOf('\',') + 3);
        var url = str.substr(0, str.indexOf('\','));
        str = str.substr(str.indexOf('\',') + 3);
        var pageTitle = str.substr(0, str.indexOf('\','));
        str = str.substr(str.indexOf('\',') + 3);
        var componentGuid = str.substr(0, str.length - 3);
        return { name: name, url: url, page: parseInt(pageTitle.substr(5), 10) - 1, compunentGuid: componentGuid, nodes: [], open: false, selected: false };
    };
    BookmarksPanelComponent.prototype.unescape = function (str) {
        return str.replace(/\\&apos;/g, '\'')
            .replace(/\\&quot;/g, '"')
            .replace(/\\&gt;/g, '>')
            .replace(/\\&lt;/g, '<')
            .replace(/\\&amp;/g, '&');
    };
    Object.defineProperty(BookmarksPanelComponent.prototype, "bottom", {
        get: function () {
            if (this.model.options.isMobileDevice) {
                return this.model.options.toolbar.autoHide ? '0' : '0.5in';
            }
            else {
                return this.model.options.toolbar.displayMode === 'Separated' && this.model.options.toolbar.visible ? '35px' : '0';
            }
        },
        enumerable: true,
        configurable: true
    });
    BookmarksPanelComponent.ctorParameters = function () { return [
        { type: ModelService },
        { type: HelperService },
        { type: ControllerService }
    ]; };
    __decorate([
        ViewChild('element')
    ], BookmarksPanelComponent.prototype, "element", void 0);
    __decorate([
        ViewChild('bookmarksPanel')
    ], BookmarksPanelComponent.prototype, "bookmarksPanel", void 0);
    BookmarksPanelComponent = __decorate([
        Component({
            selector: 'sti-bookmarks-panel',
            template: "\n    <div #element [style]=\"{fontFamily: model.options.toolbar.fontFamily, fontColor: helper.val(model.options.toolbar.fontColor)}\"\n      [class]=\"'stiJsViewerBookmarksPanel' + (model.options.toolbar.displayMode == 'Separated' ? ' stiJsViewerBookmarksPanelSeparated' : '')\"\n      [style.width.px]=\"model.options.appearance.bookmarksTreeWidth - (model.options.toolbar.displayMode == 'Simple' ? 0 : 1)\"\n      [style.bottom]=\"bottom\"\n      [style.top.px]=\"model.controls.bookmarksPanel.layout.top\"\n      [style.transition]=\"model.options.isMobileDevice ? 'opacity 300ms ease' : null\"\n      [style.display]=\"!this.model.options.isMobileDevice ? (model.controls.bookmarksPanel.visible ? '' : 'none') : null\"\n      [@visibility]=\"!this.model.options.isMobileDevice ? null : (model.controls.bookmarksPanel.visible ? 'visible' : 'hidden')\">\n      <div #bookmarksPanel [class]=\"'stiJsViewerBookmarksContainer' + (model.options.toolbar.displayMode == 'Simple' ? ' stiJsViewerBookmarksContainerSimple' : '')\"\n           [style.background]=\"helper.val(model.options.toolbar.backgroundColor)\"\n           [style.border]=\"helper.val(model.options.toolbar.borderColor) != '' ? '1px solid ' + helper.val(model.options.toolbar.borderColor): ''\">\n           <div class=\"stiTree\">\n              <div class=\"stiTreeNode\">\n                <img style=\"width: 16px; height: 16px;\" [src]=\"model.imagesForBookmark['root']\"/>\n                <a class=\"node\">{{rootName}}</a>\n              </div>\n              <div class=\"clip\" style=\"display:block;\">\n                <ng-container *ngFor=\"let node of model.nodes; index as i\">\n                    <div class=\"stiTreeNode\">\n                        <a (click)=\"node.open = !node.open\">\n                            <img style=\"width: 18px; height: 18px\"\n                             [src]=\"getImg1(node, i)\"/>\n                        </a>\n                        <img style=\"width: 16px; height: 16px;\" [src]=\"node.nodes?.length == 0 ? model.imagesForBookmark['node'] :(node.open ? model.imagesForBookmark['folderOpen'] : model.imagesForBookmark['folder'])\"/>\n                        <a [class]=\"node.selected ? 'nodeSel' : 'node'\" (click)=\"postAction(node)\">{{node.name}}</a>\n                    </div>\n                    <div class=\"clip\" [style.display]=\"node.open ? 'block' : 'none'\">\n                      <div *ngFor=\"let subNode of node.nodes; index as k\" class=\"stiTreeNode\">\n                        <img style=\"width: 18px; height: 18px;\" [src]=\"i != model.nodes.length - 1 ? model.imagesForBookmark['line'] : model.imagesForBookmark['empty']\"/>\n                        <img style=\"width: 18px; height: 18px;\" [src]=\"k == node.nodes.length - 1 ? model.imagesForBookmark['joinBottom'] : model.imagesForBookmark['join']\"/>\n                        <img style=\"width: 16px; height: 16px;\" [src]=\"model.imagesForBookmark['node']\" />\n                        <a [class]=\"subNode.selected ? 'nodeSel' : 'node'\" (click)=\"postAction(subNode)\">{{subNode.name}}</a>\n                      </div>\n                    </div>\n                </ng-container>\n              </div>\n          </div>\n      </div>\n    </div>\n  ",
            animations: [
                trigger('visibility', [
                    state('visible', style({ opacity: 1, display: 'block' })),
                    state('hidden', style({ opacity: 0, display: 'none' })),
                    transition('hidden => visible', [
                        animate('300ms ease-in-out', keyframes([
                            style({ display: 'block', opacity: 0, offset: 0 }),
                            style({ display: 'block', opacity: 1, offset: 1 }),
                        ]))
                    ]),
                    transition('visible => hidden', [
                        animate('300ms ease-in-out', keyframes([
                            style({ display: 'block', opacity: 1, offset: 0 }),
                            style({ display: 'none', opacity: 0, offset: 1 }),
                        ]))
                    ])
                ])
            ]
        })
    ], BookmarksPanelComponent);
    return BookmarksPanelComponent;
}());
export { BookmarksPanelComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9va21hcmtzLXBhbmVsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3N0aW11bHNvZnQtdmlld2VyLWFuZ3VsYXIvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9ib29rbWFya3MtcGFuZWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFNBQVMsRUFBNkIsTUFBTSxlQUFlLENBQUM7QUFDeEYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUVuRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQWtCLE1BQU0scUJBQXFCLENBQUM7QUFpRTVHO0lBT0UsaUNBQW1CLEtBQW1CLEVBQVMsTUFBcUIsRUFBUyxVQUE2QjtRQUExRyxpQkEyQkM7UUEzQmtCLFVBQUssR0FBTCxLQUFLLENBQWM7UUFBUyxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQVMsZUFBVSxHQUFWLFVBQVUsQ0FBbUI7UUFDeEcsVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxVQUFDLE9BQWdCO1lBQ2pELElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxXQUFXLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxZQUFZLEVBQUU7Z0JBQ3JFLFVBQVUsQ0FBQztvQkFDVCxJQUFJLEtBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLGdCQUFnQixJQUFJLElBQUksRUFBRTt3QkFDcEQsS0FBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO3FCQUNmO29CQUNELEtBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEdBQUcsS0FBSSxDQUFD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QUFLLENBQUMsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDO3lCQUNsRCxDQUFDLENBQUM7cUJBQ0osQ0FBQztpQkFDSCxDQUFDO2FBQ0g7U0FDRixDQUFDO09BRVcsdUJBQXVCLENBb0huQztJQUFELDhCQUFDO0NBQUEsQUFwSEQsSUFvSEM7U0FwSFksdUJBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIFZpZXdDaGlsZCwgRWxlbWVudFJlZiwgQWZ0ZXJWaWV3SW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBNb2RlbFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9tb2RlbC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgSGVscGVyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2hlbHBlci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ29udHJvbGxlclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9jb250cm9sbGVyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBCb29rbWFya05vZGUsIE1lc3NhZ2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9vYmplY3RzJztcclxuaW1wb3J0IHsgdHJpZ2dlciwgc3RhdGUsIHRyYW5zaXRpb24sIGFuaW1hdGUsIHN0eWxlLCBrZXlmcmFtZXMsIEFuaW1hdGlvbkV2ZW50IH0gZnJvbSAnQGFuZ3VsYXIvYW5pbWF0aW9ucyc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3N0aS1ib29rbWFya3MtcGFuZWwnLFxyXG4gIHRlbXBsYXRlOiBgXHJcbiAgICA8ZGl2ICNlbGVtZW50IFtzdHlsZV09XCJ7Zm9udEZhbWlseTogbW9kZWwub3B0aW9ucy50b29sYmFyLmZvbnRGYW1pbHksIGZvbnRDb2xvcjogaGVscGVyLnZhbChtb2RlbC5vcHRpb25zLnRvb2xiYXIuZm9udENvbG9yKX1cIlxyXG4gICAgICBbY2xhc3NdPVwiJ3N0aUpzVmlld2VyQm9va21hcmtzUGFuZWwnICsgKG1vZGVsLm9wdGlvbnMudG9vbGJhci5kaXNwbGF5TW9kZSA9PSAnU2VwYXJhdGVkJyA/ICcgc3RpSnNWaWV3ZXJCb29rbWFya3NQYW5lbFNlcGFyYXRlZCcgOiAnJylcIlxyXG4gICAgICBbc3R5bGUud2lkdGgucHhdPVwibW9kZWwub3B0aW9ucy5hcHBlYXJhbmNlLmJvb2ttYXJrc1RyZWVXaWR0aCAtIChtb2RlbC5vcHRpb25zLnRvb2xiYXIuZGlzcGxheU1vZGUgPT0gJ1NpbXBsZScgPyAwIDogMSlcIlxyXG4gICAgICBbc3R5bGUuYm90dG9tXT1cImJvdHRvbVwiXHJcbiAgICAgIFtzdHlsZS50b3AucHhdPVwibW9kZWwuY29udHJvbHMuYm9va21hcmtzUGFuZWwubGF5b3V0LnRvcFwiXHJcbiAgICAgIFtzdHlsZS50cmFuc2l0aW9uXT1cIm1vZGVsLm9wdGlvbnMuaXNNb2JpbGVEZXZpY2UgPyAnb3BhY2l0eSAzMDBtcyBlYXNlJyA6IG51bGxcIlxyXG4gICAgICBbc3R5bGUuZGlzcGxheV09XCIhdGhpcy5tb2RlbC5vcHRpb25zLmlzTW9iaWxlRGV2aWNlID8gKG1vZGVsLmNvbnRyb2xzLmJvb2ttYXJrc1BhbmVsLnZpc2libGUgPyAnJyA6ICdub25lJykgOiBudWxsXCJcclxuICAgICAgW0B2aXNpYmlsaXR5XT1cIiF0aGlzLm1vZGVsLm9wdGlvbnMuaXNNb2JpbGVEZXZpY2UgPyBudWxsIDogKG1vZGVsLmNvbnRyb2xzLmJvb2ttYXJrc1BhbmVsLnZpc2libGUgPyAndmlzaWJsZScgOiAnaGlkZGVuJylcIj5cclxuICAgICAgPGRpdiAjYm9va21hcmtzUGFuZWwgW2NsYXNzXT1cIidzdGlKc1ZpZXdlckJvb2ttYXJrc0NvbnRhaW5lcicgKyAobW9kZWwub3B0aW9ucy50b29sYmFyLmRpc3BsYXlNb2RlID09ICdTaW1wbGUnID8gJyBzdGlKc1ZpZXdlckJvb2ttYXJrc0NvbnRhaW5lclNpbXBsZScgOiAnJylcIlxyXG4gICAgICAgICAgIFtzdHlsZS5iYWNrZ3JvdW5kXT1cImhlbHBlci52YWwobW9kZWwub3B0aW9ucy50b29sYmFyLmJhY2tncm91bmRDb2xvcilcIlxyXG4gICAgICAgICAgIFtzdHlsZS5ib3JkZXJdPVwiaGVscGVyLnZhbChtb2RlbC5vcHRpb25zLnRvb2xiYXIuYm9yZGVyQ29sb3IpICE9ICcnID8gJzFweCBzb2xpZCAnICsgaGVscGVyLnZhbChtb2RlbC5vcHRpb25zLnRvb2xiYXIuYm9yZGVyQ29sb3IpOiAnJ1wiPlxyXG4gICAgICAgICAgIDxkaXYgY2xhc3M9XCJzdGlUcmVlXCI+XHJcbiAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cInN0aVRyZWVOb2RlXCI+XHJcbiAgICAgICAgICAgICAgICA8aW1nIHN0eWxlPVwid2lkdGg6IDE2cHg7IGhlaWdodDogMTZweDtcIiBbc3JjXT1cIm1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydyb290J11cIi8+XHJcbiAgICAgICAgICAgICAgICA8YSBjbGFzcz1cIm5vZGVcIj57e3Jvb3ROYW1lfX08L2E+XHJcbiAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cImNsaXBcIiBzdHlsZT1cImRpc3BsYXk6YmxvY2s7XCI+XHJcbiAgICAgICAgICAgICAgICA8bmctY29udGFpbmVyICpuZ0Zvcj1cImxldCBub2RlIG9mIG1vZGVsLm5vZGVzOyBpbmRleCBhcyBpXCI+XHJcbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cInN0aVRyZWVOb2RlXCI+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDxhIChjbGljayk9XCJub2RlLm9wZW4gPSAhbm9kZS5vcGVuXCI+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW1nIHN0eWxlPVwid2lkdGg6IDE4cHg7IGhlaWdodDogMThweFwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW3NyY109XCJnZXRJbWcxKG5vZGUsIGkpXCIvPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8L2E+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDxpbWcgc3R5bGU9XCJ3aWR0aDogMTZweDsgaGVpZ2h0OiAxNnB4O1wiIFtzcmNdPVwibm9kZS5ub2Rlcz8ubGVuZ3RoID09IDAgPyBtb2RlbC5pbWFnZXNGb3JCb29rbWFya1snbm9kZSddIDoobm9kZS5vcGVuID8gbW9kZWwuaW1hZ2VzRm9yQm9va21hcmtbJ2ZvbGRlck9wZW4nXSA6IG1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydmb2xkZXInXSlcIi8+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDxhIFtjbGFzc109XCJub2RlLnNlbGVjdGVkID8gJ25vZGVTZWwnIDogJ25vZGUnXCIgKGNsaWNrKT1cInBvc3RBY3Rpb24obm9kZSlcIj57e25vZGUubmFtZX19PC9hPlxyXG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjbGlwXCIgW3N0eWxlLmRpc3BsYXldPVwibm9kZS5vcGVuID8gJ2Jsb2NrJyA6ICdub25lJ1wiPlxyXG4gICAgICAgICAgICAgICAgICAgICAgPGRpdiAqbmdGb3I9XCJsZXQgc3ViTm9kZSBvZiBub2RlLm5vZGVzOyBpbmRleCBhcyBrXCIgY2xhc3M9XCJzdGlUcmVlTm9kZVwiPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8aW1nIHN0eWxlPVwid2lkdGg6IDE4cHg7IGhlaWdodDogMThweDtcIiBbc3JjXT1cImkgIT0gbW9kZWwubm9kZXMubGVuZ3RoIC0gMSA/IG1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydsaW5lJ10gOiBtb2RlbC5pbWFnZXNGb3JCb29rbWFya1snZW1wdHknXVwiLz5cclxuICAgICAgICAgICAgICAgICAgICAgICAgPGltZyBzdHlsZT1cIndpZHRoOiAxOHB4OyBoZWlnaHQ6IDE4cHg7XCIgW3NyY109XCJrID09IG5vZGUubm9kZXMubGVuZ3RoIC0gMSA/IG1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydqb2luQm90dG9tJ10gOiBtb2RlbC5pbWFnZXNGb3JCb29rbWFya1snam9pbiddXCIvPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8aW1nIHN0eWxlPVwid2lkdGg6IDE2cHg7IGhlaWdodDogMTZweDtcIiBbc3JjXT1cIm1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydub2RlJ11cIiAvPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8YSBbY2xhc3NdPVwic3ViTm9kZS5zZWxlY3RlZCA/ICdub2RlU2VsJyA6ICdub2RlJ1wiIChjbGljayk9XCJwb3N0QWN0aW9uKHN1Yk5vZGUpXCI+e3tzdWJOb2RlLm5hbWV9fTwvYT5cclxuICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICAgPC9uZy1jb250YWluZXI+XHJcbiAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICA8L2Rpdj5cclxuICAgICAgPC9kaXY+XHJcbiAgICA8L2Rpdj5cclxuICBgLFxyXG4gIGFuaW1hdGlvbnM6IFtcclxuICAgIHRyaWdnZXIoJ3Zpc2liaWxpdHknLCBbXHJcbiAgICAgIHN0YXRlKCd2aXNpYmxlJywgc3R5bGUoeyBvcGFjaXR5OiAxLCBkaXNwbGF5OiAnYmxvY2snIH0pKSxcclxuICAgICAgc3RhdGUoJ2hpZGRlbicsIHN0eWxlKHsgb3BhY2l0eTogMCwgZGlzcGxheTogJ25vbmUnIH0pKSxcclxuICAgICAgdHJhbnNpdGlvbignaGlkZGVuID0+IHZpc2libGUnLCBbXHJcbiAgICAgICAgYW5pbWF0ZSgnMzAwbXMgZWFzZS1pbi1vdXQnLCBrZXlmcmFtZXMoW1xyXG4gICAgICAgICAgc3R5bGUoeyBkaXNwbGF5OiAnYmxvY2snLCBvcGFjaXR5OiAwLCBvZmZzZXQ6IDAgfSksXHJcbiAgICAgICAgICBzdHlsZSh7IGRpc3BsYXk6ICdibG9jaycsIG9wYWNpdHk6IDEsIG9mZnNldDogMSB9KSxcclxuICAgICAgICBdKSlcclxuICAgICAgXSksXHJcbiAgICAgIHRyYW5zaXRpb24oJ3Zpc2libGUgPT4gaGlkZGVuJywgW1xyXG4gICAgICAgIGFuaW1hdGUoJzMwMG1zIGVhc2UtaW4tb3V0Jywga2V5ZnJhbWVzKFtcclxuICAgICAgICAgIHN0eWxlKHsgZGlzcGxheTogJ2Jsb2NrJywgb3BhY2l0eTogMSwgb2Zmc2V0OiAwIH0pLFxyXG4gICAgICAgICAgc3R5bGUoeyBkaXNwbGF5OiAnbm9uZScsIG9wYWNpdHk6IDAsIG9mZnNldDogMSB9KSxcclxuICAgICAgICBdKSlcclxuICAgICAgXSlcclxuICAgIF0pXHJcbiAgXVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIEJvb2ttYXJrc1BhbmVsQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgQFZpZXdDaGlsZCgnZWxlbWVudCcpIGVsZW1lbnQ6IEVsZW1lbnRSZWY7XHJcbiAgQFZpZXdDaGlsZCgnYm9va21hcmtzUGFuZWwnKSBib29rbWFya3NQYW5lbDogRWxlbWVudFJlZjtcclxuXHJcbiAgcHVibGljIHJvb3ROYW1lOiBzdHJpbmc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBtb2RlbDogTW9kZWxTZXJ2aWNlLCBwdWJsaWMgaGVscGVyOiBIZWxwZXJTZXJ2aWNlLCBwdWJsaWMgY29udHJvbGxlcjogQ29udHJvbGxlclNlcnZpY2UpIHtcclxuICAgIGNvbnRyb2xsZXIuZ2V0TWVzc2FnZSgpLnN1YnNjcmliZSgobWVzc2FnZTogTWVzc2FnZSkgPT4ge1xyXG4gICAgICBpZiAobWVzc2FnZS5hY3Rpb24gPT09ICdHZXRSZXBvcnQnIHx8IG1lc3NhZ2UuYWN0aW9uID09PSAnT3BlblJlcG9ydCcpIHtcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIGlmICh0aGlzLm1vZGVsLnJlcG9ydFBhcmFtcy5ib29rbWFya3NDb250ZW50ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHRoaXMubW9kZWwuY29udHJvbHMuYm9va21hcmtzUGFuZWwudmlzaWJsZSA9IHRoaXMubW9kZWwucmVwb3J0UGFyYW1zLmJvb2ttYXJrc0NvbnRlbnQgIT09IG51bGwgJiYgIXRoaXMubW9kZWwub3B0aW9ucy5pc01vYmlsZURldmljZTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBHbyB0byB0aGUgYm9va21hcmssIGlmIGl0IHByZXNlbnRcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIGlmICh0aGlzLm1vZGVsLm9wdGlvbnMuYm9va21hcmtBbmNob3IgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLmhlbHBlci5zY3JvbGxUb0FuY2hvcih0aGlzLm1vZGVsLm9wdGlvbnMuYm9va21hcmtBbmNob3IsIHRoaXMubW9kZWwub3B0aW9ucy5jb21wb25lbnRHdWlkKTtcclxuICAgICAgICAgICAgdGhpcy5tb2RlbC5vcHRpb25zLmJvb2ttYXJrQW5jaG9yID0gbnVsbDtcclxuICAgICAgICAgICAgdGhpcy5tb2RlbC5vcHRpb25zLmNvbXBvbmVudEd1aWQgPSBudWxsO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLm1vZGVsLmNvbnRyb2xzLmJvb2ttYXJrc1BhbmVsLmdldFZpc2liaWxpdHkoKS5zdWJzY3JpYmUoKHZhbHVlKSA9PiB7XHJcbiAgICAgIGlmICghdmFsdWUpIHtcclxuICAgICAgICB0aGlzLmhlbHBlci5yZW1vdmVCb29rbWFya3NMYWJlbCgpO1xyXG4gICAgICAgIHRoaXMuY2xlYXJTZWxlY3RlZCgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMubW9kZWwuY29udHJvbHMuYm9va21hcmtzUGFuZWwuZWwgPSB0aGlzLmVsZW1lbnQ7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHsgfVxyXG5cclxuICBwdWJsaWMgZ2V0SW1nMShub2RlOiBCb29rbWFya05vZGUsIGk6IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICBpZiAobm9kZS5ub2Rlcz8ubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBpICE9PSB0aGlzLm1vZGVsLm5vZGVzLmxlbmd0aCAtIDEgPyB0aGlzLm1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydqb2luJ10gOiB0aGlzLm1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydqb2luQm90dG9tJ107XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbm9kZS5vcGVuID8gKGkgPT09IHRoaXMubW9kZWwubm9kZXMubGVuZ3RoIC0gMSA/IHRoaXMubW9kZWwuaW1hZ2VzRm9yQm9va21hcmtbJ21pbnVzQm90dG9tJ10gOiB0aGlzLm1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydtaW51cyddKSA6XHJcbiAgICAgIChpID09PSB0aGlzLm1vZGVsLm5vZGVzLmxlbmd0aCAtIDEgPyB0aGlzLm1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydwbHVzQm90dG9tJ10gOiB0aGlzLm1vZGVsLmltYWdlc0ZvckJvb2ttYXJrWydwbHVzJ10pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHBvc3RBY3Rpb24obm9kZTogQm9va21hcmtOb2RlKSB7XHJcbiAgICB0aGlzLmNsZWFyU2VsZWN0ZWQoKTtcclxuICAgIHRoaXMuY29udHJvbGxlci5wb3N0Qm9va21hcmtOb2RlQWN0aW9uKG5vZGUpO1xyXG4gIH1cclxuXHJcbiAgY2xlYXJTZWxlY3RlZCgpIHtcclxuICAgIHRoaXMubW9kZWwubm9kZXM/LmZvckVhY2goKG4pID0+IHtcclxuICAgICAgbi5zZWxlY3RlZCA9IGZhbHNlO1xyXG4gICAgICBuLm5vZGVzLmZvckVhY2goZWxlbWVudCA9PiBlbGVtZW50LnNlbGVjdGVkID0gZmFsc2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBjcmVhdGUoKSB7XHJcbiAgICBjb25zdCBib29rbWFya3MgPSB0aGlzLm1vZGVsLnJlcG9ydFBhcmFtcy5ib29rbWFya3NDb250ZW50LnNwbGl0KCdib29rbWFya3MuYWRkKCcpO1xyXG5cclxuICAgIGNvbnN0IHJvb3QgPSBib29rbWFya3NbMV0ucmVwbGFjZSgnMCwtMSxcXCcnLCAnJyk7XHJcbiAgICB0aGlzLnJvb3ROYW1lID0gcm9vdC5zdWJzdHIoMCwgcm9vdC5pbmRleE9mKCdcXCcnKSk7XHJcblxyXG4gICAgY29uc3Qgbm9kZXM6IEJvb2ttYXJrTm9kZVtdID0gW107XHJcbiAgICB0aGlzLnBhcnNlTm9kZXMoYm9va21hcmtzLnNwbGljZSgyKSwgMCwgbm9kZXMpO1xyXG4gICAgdGhpcy5tb2RlbC5ub2RlcyA9IG5vZGVzO1xyXG4gIH1cclxuXHJcbiAgcGFyc2VOb2Rlcyhib29rbWFya3M6IHN0cmluZ1tdLCBpbmRleDogbnVtYmVyLCBub2RlczogQm9va21hcmtOb2RlW10pIHtcclxuICAgIGxldCBmb2xkZXI6IEJvb2ttYXJrTm9kZTtcclxuICAgIGJvb2ttYXJrcy5mb3JFYWNoKChib29rbWFyaykgPT4ge1xyXG4gICAgICBjb25zdCBzdHIgPSBib29rbWFyay5zdWJzdHIoYm9va21hcmsuaW5kZXhPZignLCcpICsgMSk7XHJcbiAgICAgIGNvbnN0IG5vZGVUeXBlID0gcGFyc2VJbnQoc3RyLnN1YnN0cigwLCBzdHIuaW5kZXhPZignLCcpKSwgMTApO1xyXG4gICAgICBjb25zdCBub2RlID0gdGhpcy5wYXJzZU5vZGUoc3RyKTtcclxuICAgICAgaWYgKG5vZGVUeXBlID09PSAwKSB7XHJcbiAgICAgICAgbm9kZXMucHVzaChub2RlKTtcclxuICAgICAgICBmb2xkZXIgPSBub2RlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGZvbGRlci5ub2Rlcy5wdXNoKG5vZGUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHBhcnNlTm9kZShzdHI6IHN0cmluZyk6IEJvb2ttYXJrTm9kZSB7XHJcbiAgICBzdHIgPSBzdHIuc3Vic3RyKHN0ci5pbmRleE9mKCcsJykgKyAyKTtcclxuICAgIGNvbnN0IG5hbWUgPSB0aGlzLnVuZXNjYXBlKHN0ci5zdWJzdHIoMCwgc3RyLmluZGV4T2YoJ1xcJywnKSkpO1xyXG4gICAgc3RyID0gc3RyLnN1YnN0cihzdHIuaW5kZXhPZignXFwnLCcpICsgMyk7XHJcbiAgICBjb25zdCB1cmwgPSBzdHIuc3Vic3RyKDAsIHN0ci5pbmRleE9mKCdcXCcsJykpO1xyXG4gICAgc3RyID0gc3RyLnN1YnN0cihzdHIuaW5kZXhPZignXFwnLCcpICsgMyk7XHJcbiAgICBjb25zdCBwYWdlVGl0bGUgPSBzdHIuc3Vic3RyKDAsIHN0ci5pbmRleE9mKCdcXCcsJykpO1xyXG4gICAgc3RyID0gc3RyLnN1YnN0cihzdHIuaW5kZXhPZignXFwnLCcpICsgMyk7XHJcbiAgICBjb25zdCBjb21wb25lbnRHdWlkID0gc3RyLnN1YnN0cigwLCBzdHIubGVuZ3RoIC0gMyk7XHJcbiAgICByZXR1cm4geyBuYW1lLCB1cmwsIHBhZ2U6IHBhcnNlSW50KHBhZ2VUaXRsZS5zdWJzdHIoNSksIDEwKSAtIDEsIGNvbXB1bmVudEd1aWQ6IGNvbXBvbmVudEd1aWQsIG5vZGVzOiBbXSwgb3BlbjogZmFsc2UsIHNlbGVjdGVkOiBmYWxzZSB9O1xyXG4gIH1cclxuXHJcbiAgdW5lc2NhcGUoc3RyOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9cXFxcJmFwb3M7L2csICdcXCcnKVxyXG4gICAgICAucmVwbGFjZSgvXFxcXCZxdW90Oy9nLCAnXCInKVxyXG4gICAgICAucmVwbGFjZSgvXFxcXCZndDsvZywgJz4nKVxyXG4gICAgICAucmVwbGFjZSgvXFxcXCZsdDsvZywgJzwnKVxyXG4gICAgICAucmVwbGFjZSgvXFxcXCZhbXA7L2csICcmJyk7XHJcbiAgfVxyXG5cclxuICBnZXQgYm90dG9tKCk6IHN0cmluZyB7XHJcbiAgICBpZiAodGhpcy5tb2RlbC5vcHRpb25zLmlzTW9iaWxlRGV2aWNlKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLm1vZGVsLm9wdGlvbnMudG9vbGJhci5hdXRvSGlkZSA/ICcwJyA6ICcwLjVpbic7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhpcy5tb2RlbC5vcHRpb25zLnRvb2xiYXIuZGlzcGxheU1vZGUgPT09ICdTZXBhcmF0ZWQnICYmIHRoaXMubW9kZWwub3B0aW9ucy50b29sYmFyLnZpc2libGUgPyAnMzVweCcgOiAnMCc7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=