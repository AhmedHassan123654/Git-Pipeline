name: E2E Regression Test on Windows

on:
  push:
    branches:
      - main

jobs:
  regression-tests:
    runs-on: windows-latest   # هنا نستخدم Windows runner

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v6

      # 2. Setup Java (لـ Maven / Spring Boot)
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # 3. Install Chrome
      - name: Install Chrome
        run: |
          choco install googlechrome -y

      # 4. Install ChromeDriver
      - name: Install ChromeDriver
        run: |
          $chromeVersion = (Get-Item "C:\Program Files\Google\Chrome\Application\chrome.exe").VersionInfo.ProductVersion.Split(".")[0]
          Write-Host "Chrome major version: $chromeVersion"
          $latestDriver = Invoke-RestMethod "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$chromeVersion"
          Write-Host "ChromeDriver version: $latestDriver"
          Invoke-WebRequest -Uri "https://chromedriver.storage.googleapis.com/$latestDriver/chromedriver_win32.zip" -OutFile "chromedriver.zip"
          Expand-Archive chromedriver.zip -DestinationPath "C:\chromedriver"
          setx PATH "$env:PATH;C:\chromedriver"

      # 5. Run Backend (Spring Boot)
      - name: Build & Run Backend
        run: |
          cd POS-BackPublish
          mvn clean install
          start cmd /k "mvn spring-boot:run"

      # 6. Run Frontend (Angular)
      - name: Build & Run Frontend
        run: |
          cd POS-Front-19-10-2025
          npm install
          start cmd /k "ng serve --host 0.0.0.0 --port 4200"

      # 7. Run Selenium Tests
      - name: Run Regression Tests
        run: |
          cd POS-BackPublish
          mvn test -DbrowserType="Chrome" -Dmaven.test.failure.ignore=true
